<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%2303050e'/><polygon points='16,2 30,9 30,23 16,30 2,23 2,9' fill='none' stroke='%23e8b840' stroke-width='2'/><text x='16' y='20' text-anchor='middle' font-size='9' font-weight='bold' font-family='monospace' fill='%23e8b840'>ADM</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LABS67 Admin</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#03050e;--bg2:#060916;--panel:#08101f;
  --b1:rgba(255,255,255,0.07);--b2:rgba(255,255,255,0.14);
  --gold:#e8b840;--gold2:#f5cc60;--gold-dim:rgba(232,184,64,0.35);
  --cyan:#30dcff;--green:#1df59a;--red:#ff4d6d;
  --text:#cdd8f5;--muted:rgba(160,185,240,0.42);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;}

/* TOPBAR */
.topbar{position:fixed;top:0;left:0;right:0;z-index:100;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(3,5,14,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--b1);}
.tb-logo{display:flex;align-items:center;gap:10px;}
.tb-mark{width:28px;height:28px;background:linear-gradient(135deg,var(--gold),var(--gold2));clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:0.48rem;font-weight:700;color:#03050e;}
.tb-name{font-size:0.85rem;font-weight:800;letter-spacing:0.15em;}
.tb-name em{color:var(--gold);font-style:normal;}
.tb-badge{font-family:'JetBrains Mono',monospace;font-size:0.45rem;letter-spacing:0.25em;color:var(--muted);border:1px solid var(--b1);padding:3px 8px;}
.tb-r{display:flex;align-items:center;gap:12px;}
.tb-status{display:flex;align-items:center;gap:6px;font-family:'JetBrains Mono',monospace;font-size:0.5rem;letter-spacing:0.1em;color:var(--green);}
.tb-dot{width:5px;height:5px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.tb-time{font-family:'JetBrains Mono',monospace;font-size:0.5rem;color:var(--muted);}

/* LAYOUT */
.layout{display:grid;grid-template-columns:300px 1fr 320px;height:100vh;padding-top:52px;}

/* PANE */
.pane{border-right:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;}
.pane-hdr{padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;background:var(--panel);flex-shrink:0;}
.pane-title{font-family:'JetBrains Mono',monospace;font-size:0.55rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--gold);}
.pane-count{font-family:'JetBrains Mono',monospace;font-size:0.48rem;color:var(--muted);background:var(--b1);padding:2px 8px;border-radius:2px;}
.pane-body{flex:1;overflow-y:auto;}
.pane-body::-webkit-scrollbar{width:3px;}
.pane-body::-webkit-scrollbar-thumb{background:var(--b2);}

/* STATS */
.stats-bar{display:flex;gap:1px;background:var(--b1);border-bottom:1px solid var(--b1);flex-shrink:0;}
.stat-item{flex:1;padding:8px 10px;background:var(--bg2);text-align:center;}
.stat-num{font-size:1.1rem;font-weight:800;color:var(--gold);display:block;}
.stat-lbl{font-family:'JetBrains Mono',monospace;font-size:0.4rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);display:block;margin-top:1px;}

/* FILTER */
.filter-bar{padding:8px 12px;border-bottom:1px solid var(--b1);display:flex;gap:4px;flex-wrap:wrap;background:var(--bg2);flex-shrink:0;}
.fb{padding:3px 9px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.43rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;}
.fb:hover,.fb.active{color:var(--gold);border-color:var(--gold-dim);}

/* LEAD ITEMS */
.lead-item{padding:12px 14px;border-bottom:1px solid var(--b1);cursor:pointer;transition:background 0.15s;position:relative;}
.lead-item:hover{background:rgba(255,255,255,0.02);}
.lead-item.selected{background:rgba(232,184,64,0.05);border-left:2px solid var(--gold);}
.lead-item.unread::after{content:'';position:absolute;top:12px;right:12px;width:6px;height:6px;border-radius:50%;background:var(--gold);box-shadow:0 0 6px var(--gold);}
.li-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
.li-name{font-size:0.8rem;font-weight:700;}
.li-time{font-family:'JetBrains Mono',monospace;font-size:0.43rem;color:var(--muted);}
.li-src{font-family:'JetBrains Mono',monospace;font-size:0.43rem;letter-spacing:0.08em;margin-bottom:4px;}
.li-src.dental{color:var(--gold);}
.li-src.trade{color:var(--cyan);}
.li-src.academi{color:var(--green);}
.li-src.franchise{color:var(--red);}
.li-src.main{color:var(--muted);}
.li-preview{font-size:0.72rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.li-tags{display:flex;gap:3px;margin-top:5px;}
.ltag{font-family:'JetBrains Mono',monospace;font-size:0.4rem;padding:2px 6px;border:1px solid var(--b1);color:var(--muted);}
.ltag.new{border-color:rgba(29,245,154,0.4);color:var(--green);}
.ltag.hot{border-color:rgba(255,77,109,0.4);color:var(--red);}
.ltag.contacted{border-color:rgba(232,184,64,0.3);color:var(--gold);}

/* CHAT AREA */
.chat-area{display:flex;flex-direction:column;overflow:hidden;}
.chat-bar{padding:10px 18px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;background:var(--panel);flex-shrink:0;}
.cb-l{display:flex;align-items:center;gap:10px;}
.cb-av{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;color:#03050e;font-family:'JetBrains Mono',monospace;}
.cb-name{font-size:0.85rem;font-weight:700;}
.cb-meta{font-family:'JetBrains Mono',monospace;font-size:0.44rem;color:var(--muted);}
.cb-r{display:flex;gap:6px;}
.cb-btn{padding:4px 12px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.43rem;letter-spacing:0.08em;cursor:pointer;transition:all 0.2s;}
.cb-btn:hover{color:var(--gold);border-color:var(--gold-dim);}
.cb-btn.red{border-color:rgba(255,77,109,0.3);color:var(--red);}

.msgs-area{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;}
.msgs-area::-webkit-scrollbar{width:3px;}
.msgs-area::-webkit-scrollbar-thumb{background:var(--b2);}

.msg-row{display:flex;gap:8px;max-width:82%;}
.msg-row.bot{align-self:flex-start;}
.msg-row.user{align-self:flex-end;flex-direction:row-reverse;}
.msg-row.admin{align-self:flex-end;flex-direction:row-reverse;}
.msg-av{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;flex-shrink:0;margin-top:2px;}
.msg-av.bot-av{background:rgba(232,184,64,0.1);border:1px solid var(--gold-dim);}
.msg-av.user-av{background:rgba(255,255,255,0.05);border:1px solid var(--b1);}
.msg-av.admin-av{background:rgba(48,220,255,0.1);border:1px solid rgba(48,220,255,0.3);}
.msg-bubble{padding:9px 13px;font-size:0.8rem;line-height:1.6;}
.msg-bubble.bot{background:var(--panel);border:1px solid var(--b1);border-radius:0 8px 8px 8px;}
.msg-bubble.user{background:rgba(255,255,255,0.04);border:1px solid var(--b1);border-radius:8px 0 8px 8px;}
.msg-bubble.admin{background:rgba(48,220,255,0.06);border:1px solid rgba(48,220,255,0.2);border-radius:8px 0 8px 8px;}
.msg-sender{font-family:'JetBrains Mono',monospace;font-size:0.43rem;letter-spacing:0.08em;color:var(--gold);display:block;margin-bottom:4px;}
.msg-sender.admin-lbl{color:var(--cyan);}
.msg-time{font-family:'JetBrains Mono',monospace;font-size:0.4rem;color:var(--muted);margin-top:3px;display:block;}

.typing{display:flex;align-items:center;gap:4px;padding:6px 0;}
.td{width:5px;height:5px;border-radius:50%;background:var(--gold);animation:td 1.2s infinite;}
.td:nth-child(2){animation-delay:0.2s;}
.td:nth-child(3){animation-delay:0.4s;}
@keyframes td{0%,80%,100%{opacity:0.2;transform:scale(0.8);}40%{opacity:1;transform:scale(1);}}

.input-area{padding:12px 16px;border-top:1px solid var(--b1);display:flex;gap:8px;align-items:flex-end;background:var(--panel);flex-shrink:0;}
.chat-inp{flex:1;padding:9px 12px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'Syne',sans-serif;font-size:0.8rem;outline:none;resize:none;height:38px;transition:border-color 0.2s;}
.chat-inp:focus{border-color:var(--gold-dim);}
.send-btn{padding:9px 16px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;color:#03050e;font-family:'JetBrains Mono',monospace;font-size:0.5rem;font-weight:700;cursor:pointer;white-space:nowrap;}

/* RIGHT PANEL */
.right-panel{border-left:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;}
.rp-tabs{display:flex;border-bottom:1px solid var(--b1);flex-shrink:0;}
.rp-tab{flex:1;padding:11px 6px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:0.45rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);cursor:pointer;background:var(--panel);border-bottom:2px solid transparent;transition:all 0.2s;}
.rp-tab:hover{color:var(--text);}
.rp-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.rp-body{flex:1;overflow-y:auto;padding:14px;}
.rp-body::-webkit-scrollbar{width:3px;}
.rp-body::-webkit-scrollbar-thumb{background:var(--b2);}

.ld-section{margin-bottom:16px;}
.ld-lbl{font-family:'JetBrains Mono',monospace;font-size:0.44rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.ld-val{font-size:0.8rem;font-weight:600;margin-bottom:3px;}
.ld-sm{font-size:0.72rem;color:var(--muted);}
.ld-div{border:none;border-top:1px solid var(--b1);margin:12px 0;}
.status-btns{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px;}
.sb{padding:4px 10px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.43rem;cursor:pointer;transition:all 0.2s;}
.sb:hover{color:var(--gold);border-color:var(--gold-dim);}
.sb.s-new{border-color:rgba(29,245,154,0.4);color:var(--green);}
.sb.s-hot{border-color:rgba(255,77,109,0.4);color:var(--red);}
.sb.s-done{border-color:rgba(232,184,64,0.3);color:var(--gold);}
.note-area{width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'Syne',sans-serif;font-size:0.75rem;resize:vertical;min-height:70px;outline:none;margin-top:6px;}
.note-area:focus{border-color:var(--gold-dim);}
.save-btn{width:100%;margin-top:6px;padding:7px;background:var(--gold-dim);border:1px solid var(--gold-dim);color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:0.45rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;}
.save-btn:hover{background:rgba(232,184,64,0.15);}
.action-btn{width:100%;margin-top:5px;padding:7px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.43rem;cursor:pointer;transition:all 0.2s;text-align:left;}
.action-btn:hover{color:var(--gold);border-color:var(--gold-dim);}

.sg-title{font-family:'JetBrains Mono',monospace;font-size:0.48rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);margin-bottom:8px;margin-top:16px;}
.sg-title:first-child{margin-top:0;}
.sg-title::before{content:'// ';opacity:0.4;}
.ctx-area{width:100%;padding:9px;background:rgba(0,0,0,0.4);border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.62rem;line-height:1.7;resize:vertical;min-height:130px;outline:none;margin-top:6px;}
.ctx-area:focus{border-color:var(--gold-dim);}
.sel-fi{width:100%;padding:6px 8px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.52rem;outline:none;cursor:pointer;margin-top:6px;}
.sel-fi:focus{border-color:var(--gold-dim);}
option{background:#08101f;}
.save-ctx{width:100%;margin-top:6px;padding:8px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;color:#03050e;font-family:'JetBrains Mono',monospace;font-size:0.48rem;font-weight:700;cursor:pointer;}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--b1);}
.toggle-row:last-child{border-bottom:none;}
.tr-lbl{font-size:0.75rem;font-weight:600;}
.tr-sub{font-family:'JetBrains Mono',monospace;font-size:0.42rem;color:var(--muted);margin-top:1px;}
.toggle{width:34px;height:18px;background:var(--b1);border-radius:9px;cursor:pointer;position:relative;border:1px solid var(--b2);transition:all 0.3s;flex-shrink:0;}
.toggle.on{background:rgba(29,245,154,0.15);border-color:rgba(29,245,154,0.35);}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:var(--muted);transition:all 0.3s;}
.toggle.on::after{left:18px;background:var(--green);}
.int-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--b1);}
.int-row:last-child{border-bottom:none;}
.int-lbl{font-size:0.75rem;font-weight:600;}
.int-sub{font-family:'JetBrains Mono',monospace;font-size:0.42rem;margin-top:1px;}
.int-sub.ok{color:var(--green);}
.int-sub.err{color:var(--red);}
.int-btn{padding:3px 10px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.42rem;cursor:pointer;}
.int-btn.ok-btn{border-color:rgba(29,245,154,0.3);color:var(--green);}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--muted);}
.empty-ico{font-size:2rem;opacity:0.25;}
.empty-txt{font-family:'JetBrains Mono',monospace;font-size:0.52rem;letter-spacing:0.1em;}

/* NOTIF */
.notif{position:fixed;bottom:18px;right:18px;z-index:999;padding:10px 16px;background:var(--panel);border:1px solid var(--green);color:var(--green);font-family:'JetBrains Mono',monospace;font-size:0.52rem;letter-spacing:0.08em;animation:slideIn 0.3s ease;max-width:260px;}
.notif.err{border-color:var(--red);color:var(--red);}
@keyframes slideIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

.new-badge{display:inline-block;background:var(--green);color:#03050e;font-family:'JetBrains Mono',monospace;font-size:0.38rem;font-weight:700;padding:2px 5px;margin-left:6px;vertical-align:middle;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.5;}}
</style>
</head>
<body>

<div class="topbar">
  <div class="tb-logo">
    <div class="tb-mark">L67</div>
    <div>
      <div class="tb-name"><em>LABS</em>67</div>
    </div>
    <div class="tb-badge">ADMIN PANEL</div>
  </div>
  <div class="tb-r">
    <div class="tb-status"><div class="tb-dot"></div><span id="dbStatus">CONNECTING...</span></div>
    <span class="tb-time" id="clock"></span>
  </div>
</div>

<div class="layout">

  <!-- COL 1: LEADS -->
  <div class="pane">
    <div class="pane-hdr">
      <span class="pane-title">// –ó–∞—è–≤–∫–∏</span>
      <span class="pane-count" id="leadCount">0</span>
    </div>
    <div class="stats-bar">
      <div class="stat-item"><span class="stat-num" id="sNew">0</span><span class="stat-lbl">–ù–æ–≤—ã–µ</span></div>
      <div class="stat-item"><span class="stat-num" style="color:var(--red)" id="sHot">0</span><span class="stat-lbl">–ì–æ—Ä—è—á–∏–µ</span></div>
      <div class="stat-item"><span class="stat-num" style="color:var(--green)" id="sDone">0</span><span class="stat-lbl">–ó–∞–∫—Ä—ã—Ç—ã</span></div>
    </div>
    <div class="filter-bar">
      <button class="fb active" onclick="setFilter('all',this)">–í—Å–µ</button>
      <button class="fb" onclick="setFilter('dental',this)">Dental</button>
      <button class="fb" onclick="setFilter('trade',this)">Trade</button>
      <button class="fb" onclick="setFilter('academi',this)">Academi</button>
      <button class="fb" onclick="setFilter('franchise',this)">Franchise</button>
    </div>
    <div class="pane-body" id="leadsList">
      <div class="empty"><div class="empty-ico">üìã</div><div class="empty-txt">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div></div>
    </div>
  </div>

  <!-- COL 2: CHAT -->
  <div class="chat-area">
    <div class="chat-bar" id="chatBar" style="display:none;">
      <div class="cb-l">
        <div class="cb-av" id="chatAv">?</div>
        <div>
          <div class="cb-name" id="chatName">‚Äî</div>
          <div class="cb-meta" id="chatMeta">‚Äî</div>
        </div>
      </div>
      <div class="cb-r">
        <button class="cb-btn" onclick="setStatus('contacted')">‚úì Contacted</button>
        <button class="cb-btn" onclick="setStatus('hot')">üî• Hot</button>
        <button class="cb-btn red" onclick="setStatus('done')">Archive</button>
      </div>
    </div>
    <div class="msgs-area" id="msgsArea">
      <div class="empty"><div class="empty-ico">üí¨</div><div class="empty-txt">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</div></div>
    </div>
    <div class="input-area" id="inputArea" style="display:none;">
      <textarea class="chat-inp" id="adminInp" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç –∏–º–µ–Ω–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAdminMsg();}"></textarea>
      <button class="send-btn" onclick="sendAdminMsg()">SEND ‚Üí</button>
    </div>
  </div>

  <!-- COL 3: RIGHT -->
  <div class="right-panel">
    <div class="rp-tabs">
      <div class="rp-tab active" onclick="rpTab('detail',this)">–ó–∞—è–≤–∫–∞</div>
      <div class="rp-tab" onclick="rpTab('context',this)">AI –ö–æ–Ω—Ç–µ–∫—Å—Ç</div>
      <div class="rp-tab" onclick="rpTab('settings',this)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>
    <div class="rp-body" id="rpBody">
      <div class="empty" style="height:200px;"><div class="empty-ico">üìã</div><div class="empty-txt">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</div></div>
    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const SUPABASE_URL = 'https://ctdleobjnzniqkqomlrq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0ZGxlb2JqbnpuaXFrcW9tbHJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMzE4MTEsImV4cCI6MjA4NzgwNzgxMX0.AMHtY7zGPemKYCxMy2bqRTOEAp8trA_Slor9wmg7C38';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let leads = [];
let currentLead = null;
let currentFilter = 'all';
let currentRpTab = 'detail';
let messages = [];

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
setInterval(() => {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}, 1000);

// ‚îÄ‚îÄ LOAD LEADS ‚îÄ‚îÄ
async function loadLeads() {
  const { data, error } = await sb.from('leads').select('*').order('created_at', {ascending: false});
  if (error) { notify('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫', true); return; }
  leads = data || [];
  document.getElementById('dbStatus').textContent = 'DB ONLINE';
  renderLeads();
}

// ‚îÄ‚îÄ RENDER LEADS ‚îÄ‚îÄ
function renderLeads() {
  const filtered = currentFilter === 'all' ? leads : leads.filter(l => l.source === currentFilter);
  document.getElementById('leadCount').textContent = filtered.length;
  document.getElementById('sNew').textContent = leads.filter(l=>l.status==='new').length;
  document.getElementById('sHot').textContent = leads.filter(l=>l.status==='hot').length;
  document.getElementById('sDone').textContent = leads.filter(l=>l.status==='done').length;

  const list = document.getElementById('leadsList');
  if (!filtered.length) {
    list.innerHTML = '<div class="empty" style="height:200px;"><div class="empty-ico">üì≠</div><div class="empty-txt">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div></div>';
    return;
  }

  list.innerHTML = filtered.map(l => {
    const time = new Date(l.created_at).toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
    const date = new Date(l.created_at).toLocaleDateString('ru-RU', {day:'2-digit',month:'2-digit'});
    const isSelected = currentLead?.id === l.id;
    const tags = [];
    if (l.status === 'new') tags.push('<span class="ltag new">–Ω–æ–≤—ã–π</span>');
    if (l.status === 'hot') tags.push('<span class="ltag hot">üî• –≥–æ—Ä—è—á–∏–π</span>');
    if (l.status === 'contacted') tags.push('<span class="ltag contacted">contacted</span>');
    return `
      <div class="lead-item ${isSelected?'selected':''}" onclick="openLead('${l.id}')">
        <div class="li-top">
          <span class="li-name">${l.name || '–ê–Ω–æ–Ω–∏–º'}</span>
          <span class="li-time">${time} ¬∑ ${date}</span>
        </div>
        <div class="li-src ${l.source||'main'}">${(l.source||'main').toUpperCase()}</div>
        <div class="li-preview">${l.message || '‚Äî'}</div>
        <div class="li-tags">${tags.join('')}</div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ OPEN LEAD ‚îÄ‚îÄ
async function openLead(id) {
  currentLead = leads.find(l => l.id === id);
  if (!currentLead) return;
  renderLeads();

  const initials = (currentLead.name || '??').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('chatBar').style.display = 'flex';
  document.getElementById('inputArea').style.display = 'flex';
  document.getElementById('chatAv').textContent = initials;
  document.getElementById('chatName').textContent = currentLead.name || '–ê–Ω–æ–Ω–∏–º';
  document.getElementById('chatMeta').textContent = `${currentLead.phone||''} ¬∑ ${currentLead.email||''} ¬∑ ${(currentLead.source||'main').toUpperCase()}`;

  // Load messages
  const { data } = await sb.from('chat_messages').select('*').eq('lead_id', id).order('created_at', {ascending: true});
  messages = data || [];
  renderMsgs();

  if (currentRpTab === 'detail') renderDetail();
}

// ‚îÄ‚îÄ RENDER MSGS ‚îÄ‚îÄ
function renderMsgs() {
  const area = document.getElementById('msgsArea');
  if (!messages.length) {
    area.innerHTML = '<div class="empty"><div class="empty-ico">üí¨</div><div class="empty-txt">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div></div>';
    return;
  }
  area.innerHTML = messages.map(m => {
    const time = new Date(m.created_at).toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
    const isBot = m.role === 'bot';
    const isAdmin = m.role === 'admin';
    const cls = m.role || 'user';
    return `
      <div class="msg-row ${cls}">
        <div class="msg-av ${cls}-av">${isBot?'ü§ñ':isAdmin?'üë®‚Äçüíº':'üë§'}</div>
        <div>
          <div class="msg-bubble ${cls}">
            ${isBot?'<span class="msg-sender">// LABS67 AI</span>':''}
            ${isAdmin?'<span class="msg-sender admin-lbl">// Manager</span>':''}
            ${m.text}
            <span class="msg-time">${time}</span>
          </div>
        </div>
      </div>`;
  }).join('');
  area.scrollTop = area.scrollHeight;
}

// ‚îÄ‚îÄ SEND ADMIN MSG ‚îÄ‚îÄ
async function sendAdminMsg() {
  const inp = document.getElementById('adminInp');
  const text = inp.value.trim();
  if (!text || !currentLead) return;
  inp.value = '';

  const { error } = await sb.from('chat_messages').insert({
    lead_id: currentLead.id,
    role: 'admin',
    text,
    session_id: 'admin'
  });
  if (error) { notify('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', true); return; }
  const { data } = await sb.from('chat_messages').select('*').eq('lead_id', currentLead.id).order('created_at', {ascending: true});
  messages = data || [];
  renderMsgs();
}

// ‚îÄ‚îÄ SET STATUS ‚îÄ‚îÄ
async function setStatus(status) {
  if (!currentLead) return;
  await sb.from('leads').update({status}).eq('id', currentLead.id);
  currentLead.status = status;
  leads = leads.map(l => l.id === currentLead.id ? {...l, status} : l);
  renderLeads();
  if (currentRpTab === 'detail') renderDetail();
  notify(`–°—Ç–∞—Ç—É—Å ‚Üí ${status}`);
}

// ‚îÄ‚îÄ RP TABS ‚îÄ‚îÄ
function rpTab(tab, btn) {
  currentRpTab = tab;
  document.querySelectorAll('.rp-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const body = document.getElementById('rpBody');
  if (tab === 'detail') {
    if (currentLead) renderDetail();
    else body.innerHTML = '<div class="empty" style="height:200px;"><div class="empty-ico">üìã</div><div class="empty-txt">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</div></div>';
  } else if (tab === 'context') {
    body.innerHTML = `
      <div class="sg-title">–°–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</div>
      <textarea class="ctx-area" id="ctxArea">–í—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–Ω—Ü–µ—Ä–Ω–∞ LABS67. –ü–æ–º–æ–≥–∞–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏: DentalAI (—É–º–Ω—ã–µ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏), Academi67 (–æ–±—É—á–µ–Ω–∏–µ –≤—Ä–∞—á–µ–π), TradeAI (–º–µ–¥—Ç–µ—Ö —Ä–µ—à–µ–Ω–∏—è), Franchise67 (–ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ).

–°—Ç–∏–ª—å: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Ç—ë–ø–ª—ã–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π. –ë–µ–∑ —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑.

–¶–µ–ª—å: –ø–æ–Ω—è—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ ‚Üí –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –æ —à–∞–≥–µ.

–ö–æ–Ω—Ç–∞–∫—Ç—ã: hello@labs67.com, +48 571 719 800</textarea>
      <button class="save-ctx" onclick="notify('–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì')">// –°–û–•–†–ê–ù–ò–¢–¨ –ö–û–ù–¢–ï–ö–°–¢</button>
      <div class="sg-title">–¢–æ–Ω –æ–±—â–µ–Ω–∏—è</div>
      <select class="sel-fi"><option>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π + —Ç—ë–ø–ª—ã–π</option><option>–°—Ç—Ä–æ–≥–æ –¥–µ–ª–æ–≤–æ–π</option><option>–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option><option>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç</option></select>
      <div class="sg-title">–Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
      <select class="sel-fi"><option>–ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</option><option>–ë–µ–ª–∞—Ä—É—Å–∫–∞—è</option><option>–£–∫—Ä–∞–∏–Ω—Å–∫–∞—è</option><option>English</option><option>Polski</option><option>Fran√ßais</option><option>Deutsch</option></select>
      <div class="sg-title">–®–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤</div>
      <textarea class="ctx-area" style="min-height:80px;">‚Üí –ó–∞–ø–∏—Å—å: dental@labs67.com
‚Üí –ö–∞—Ç–∞–ª–æ–≥: trade@labs67.com
‚Üí –ü–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ: franchise@labs67.com
‚Üí –û–±—É—á–µ–Ω–∏–µ: academi@labs67.com</textarea>
    `;
  } else if (tab === 'settings') {
    body.innerHTML = `
      <div class="sg-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
      <div class="toggle-row"><div><div class="tr-lbl">Email –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ</div><div class="tr-sub">hello@labs67.com</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="toggle-row"><div><div class="tr-lbl">Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div></div><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
      <div class="sg-title">AI –∞–≥–µ–Ω—Ç</div>
      <div class="toggle-row"><div><div class="tr-lbl">–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –≤–∫–ª—é—á—ë–Ω</div><div class="tr-sub">AI –æ—Ç–≤–µ—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="toggle-row"><div><div class="tr-lbl">–°–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∏–∞–ª–æ–≥–∏</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="sg-title">–ú–æ–¥–µ–ª—å AI</div>
      <select class="sel-fi"><option>Claude Sonnet 4.5</option><option>Claude Haiku (–±—ã—Å—Ç—Ä—ã–π)</option><option>GPT-4o</option><option>Gemini Flash (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)</option></select>
      <div class="sg-title">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div>
      <div class="int-row"><div><div class="int-lbl">Supabase DB</div><div class="int-sub ok">‚óè –ü–æ–¥–∫–ª—é—á–µ–Ω–æ</div></div><div class="int-btn ok-btn">‚úì OK</div></div>
      <div class="int-row"><div><div class="int-lbl">OpenRouter API</div><div class="int-sub err">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div></div><button class="int-btn" onclick="notify('–î–æ–±–∞–≤—å—Ç–µ API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö')">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button></div>
      <div class="int-row"><div><div class="int-lbl">Telegram Bot</div><div class="int-sub err">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div></div><button class="int-btn" onclick="notify('–ù—É–∂–µ–Ω BOT_TOKEN –æ—Ç @BotFather')">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button></div>
    `;
  }
}

// ‚îÄ‚îÄ RENDER DETAIL ‚îÄ‚îÄ
function renderDetail() {
  const l = currentLead;
  if (!l) return;
  const body = document.getElementById('rpBody');
  const time = new Date(l.created_at).toLocaleString('ru-RU');
  body.innerHTML = `
    <div class="ld-section">
      <div class="ld-lbl">–ö–æ–Ω—Ç–∞–∫—Ç</div>
      <div class="ld-val">${l.name || '–ê–Ω–æ–Ω–∏–º'}</div>
      <div class="ld-sm">${l.phone || '‚Äî'}</div>
      <div class="ld-sm">${l.email || '‚Äî'}</div>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–ò—Å—Ç–æ—á–Ω–∏–∫</div>
      <div class="ld-val" style="color:var(--gold)">${(l.source||'main').toUpperCase()}.labs67.com</div>
      <div class="ld-sm">${time}</div>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–ó–∞–ø—Ä–æ—Å</div>
      <div class="ld-sm" style="line-height:1.6;">${l.message || '‚Äî'}</div>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–°—Ç–∞—Ç—É—Å</div>
      <div class="status-btns">
        <button class="sb ${l.status==='new'?'s-new':''}" onclick="setStatus('new')">–ù–æ–≤—ã–π</button>
        <button class="sb ${l.status==='hot'?'s-hot':''}" onclick="setStatus('hot')">üî• –ì–æ—Ä—è—á–∏–π</button>
        <button class="sb ${l.status==='contacted'?'s-done':''}" onclick="setStatus('contacted')">Contacted</button>
        <button class="sb ${l.status==='done'?'s-done':''}" onclick="setStatus('done')">‚úì –ó–∞–∫—Ä—ã—Ç</button>
      </div>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–ó–∞–º–µ—Ç–∫–∞</div>
      <textarea class="note-area" id="noteArea" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É...">${l.note||''}</textarea>
      <button class="save-btn" onclick="saveNote()">// –°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–î–µ–π—Å—Ç–≤–∏—è</div>
      <button class="action-btn" onclick="notify('üìß Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ${l.email||''}')" >‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞ ${l.email||'email'}</button>
      <button class="action-btn" onclick="notify('üìû –ó–≤–æ–Ω–æ–∫: ${l.phone||''}')" >üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å ${l.phone||''}</button>
    </div>
  `;
}

async function saveNote() {
  const note = document.getElementById('noteArea')?.value;
  if (!currentLead) return;
  await sb.from('leads').update({note}).eq('id', currentLead.id);
  currentLead.note = note;
  notify('–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úì');
}

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.fb').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderLeads();
}

// ‚îÄ‚îÄ REALTIME ‚îÄ‚îÄ
function subscribeRealtime() {
  sb.channel('leads-channel')
    .on('postgres_changes', {event:'INSERT', schema:'public', table:'leads'}, payload => {
      leads.unshift(payload.new);
      renderLeads();
      notify(`üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞: ${payload.new.name || '–ê–Ω–æ–Ω–∏–º'} ¬∑ ${(payload.new.source||'main').toUpperCase()}`);
    })
    .on('postgres_changes', {event:'UPDATE', schema:'public', table:'leads'}, payload => {
      leads = leads.map(l => l.id === payload.new.id ? payload.new : l);
      if (currentLead?.id === payload.new.id) currentLead = payload.new;
      renderLeads();
    })
    .subscribe();

  sb.channel('msgs-channel')
    .on('postgres_changes', {event:'INSERT', schema:'public', table:'chat_messages'}, payload => {
      if (currentLead && payload.new.lead_id === currentLead.id) {
        messages.push(payload.new);
        renderMsgs();
      }
    })
    .subscribe();
}

// ‚îÄ‚îÄ NOTIFY ‚îÄ‚îÄ
function notify(msg, isErr=false) {
  const el = document.createElement('div');
  el.className = 'notif' + (isErr?' err':'');
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 3500);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadLeads();
subscribeRealtime();
</script>
</body>
</html>
