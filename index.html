<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%2303050e'/%3E%3Cpolygon points='16,3 29,9.5 29,22.5 16,29 3,22.5 3,9.5' fill='none' stroke='%23e8b840' stroke-width='2'/%3E%3Ctext x='16' y='20' text-anchor='middle' font-size='8' font-weight='900' font-family='monospace' fill='%23e8b840'%3EADM%3C/text%3E%3C/svg%3E" type="image/svg+xml">
<rect width='32' height='32' fill='%2303050e'/><polygon points='16,2 30,9 30,23 16,30 2,23 2,9' fill='none' stroke='%23e8b840' stroke-width='2'/><text x='16' y='20' text-anchor='middle' font-size='9' font-weight='bold' font-family='monospace' fill='%23e8b840'>ADM</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LABS67 Admin">
<meta name="theme-color" content="#03050e">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%2303050e'/%3E%3Cpolygon points='90,15 165,52 165,128 90,165 15,128 15,52' fill='none' stroke='%23e8b840' stroke-width='8'/%3E%3Ctext x='90' y='105' text-anchor='middle' font-size='42' font-weight='900' font-family='monospace' fill='%23e8b840'%3EADM%3C/text%3E%3C/svg%3E">
<link rel="manifest" href="manifest.json">
<title id="pageTitle">LABS67 Admin Panel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#03050e;--bg2:#060916;--panel:#08101f;
  --b1:rgba(255,255,255,0.07);--b2:rgba(255,255,255,0.14);
  --gold:#e8b840;--gold2:#f5cc60;--gold-dim:rgba(232,184,64,0.35);
  --cyan:#30dcff;--green:#1df59a;--red:#ff4d6d;
  --text:#cdd8f5;--muted:rgba(160,185,240,0.42);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;}

/* TOPBAR */
.topbar{position:fixed;top:0;left:0;right:0;z-index:100;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(3,5,14,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--b1);}
.tb-logo{display:flex;align-items:center;gap:10px;}
.tb-mark{width:28px;height:28px;background:linear-gradient(135deg,var(--gold),var(--gold2));clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:0.48rem;font-weight:700;color:#03050e;}
.tb-name{font-size:0.85rem;font-weight:800;letter-spacing:0.15em;}
.tb-name em{color:var(--gold);font-style:normal;}
.tb-badge{font-family:'JetBrains Mono',monospace;font-size:0.45rem;letter-spacing:0.25em;color:var(--muted);border:1px solid var(--b1);padding:3px 8px;}
.tb-r{display:flex;align-items:center;gap:12px;}
.tb-status{display:flex;align-items:center;gap:6px;font-family:'JetBrains Mono',monospace;font-size:0.5rem;letter-spacing:0.1em;color:var(--green);}
.tb-dot{width:5px;height:5px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.tb-time{font-family:'JetBrains Mono',monospace;font-size:0.5rem;color:var(--muted);}
.tb-nav{display:flex;gap:2px;margin-left:16px;}
.tb-tab{padding:6px 16px;background:transparent;border:1px solid var(--b1);color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.5rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;border-bottom:2px solid transparent;}
.tb-tab:hover{color:var(--text);}
.tb-tab.active{color:var(--gold);border-bottom-color:var(--gold);background:rgba(232,184,64,0.05);}

/* LAYOUT */
.layout{display:grid;grid-template-columns:300px 1fr 320px;height:100vh;padding-top:52px;}

/* PANE */
.pane{border-right:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;}
.pane-hdr{padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;background:var(--panel);flex-shrink:0;}
.pane-title{font-family:'JetBrains Mono',monospace;font-size:0.55rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--gold);}
.pane-count{font-family:'JetBrains Mono',monospace;font-size:0.48rem;color:var(--muted);background:var(--b1);padding:2px 8px;border-radius:2px;}
.pane-body{flex:1;overflow-y:auto;}
.pane-body::-webkit-scrollbar{width:3px;}
.pane-body::-webkit-scrollbar-thumb{background:var(--b2);}

/* STATS */
.stats-bar{display:flex;gap:1px;background:var(--b1);border-bottom:1px solid var(--b1);flex-shrink:0;}
.stat-item{flex:1;padding:8px 10px;background:var(--bg2);text-align:center;}
.stat-num{font-size:1.1rem;font-weight:800;color:var(--gold);display:block;}
.stat-lbl{font-family:'JetBrains Mono',monospace;font-size:0.4rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);display:block;margin-top:1px;}

/* FILTER */
.filter-bar{padding:8px 12px;border-bottom:1px solid var(--b1);display:flex;gap:4px;flex-wrap:wrap;background:var(--bg2);flex-shrink:0;}
.fb{padding:3px 9px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.43rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;}
.fb:hover,.fb.active{color:var(--gold);border-color:var(--gold-dim);}

/* LEAD ITEMS */
.lead-item{padding:12px 14px;border-bottom:1px solid var(--b1);cursor:pointer;transition:background 0.15s;position:relative;}
.lead-item:hover{background:rgba(255,255,255,0.02);}
.lead-item.selected{background:rgba(232,184,64,0.05);border-left:2px solid var(--gold);}
.lead-item.unread::after{content:'';position:absolute;top:12px;right:12px;width:6px;height:6px;border-radius:50%;background:var(--gold);box-shadow:0 0 6px var(--gold);}
.li-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
.li-name{font-size:0.8rem;font-weight:700;}
.li-time{font-family:'JetBrains Mono',monospace;font-size:0.43rem;color:var(--muted);}
.li-src{font-family:'JetBrains Mono',monospace;font-size:0.43rem;letter-spacing:0.08em;margin-bottom:4px;}
.li-src.dental{color:var(--gold);}
.li-src.trade{color:var(--cyan);}
.li-src.academi{color:var(--green);}
.li-src.franchise{color:var(--red);}
.li-src.main{color:var(--muted);}
.li-preview{font-size:0.72rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.li-tags{display:flex;gap:3px;margin-top:5px;}
.ltag{font-family:'JetBrains Mono',monospace;font-size:0.4rem;padding:2px 6px;border:1px solid var(--b1);color:var(--muted);}
.ltag.new{border-color:rgba(29,245,154,0.4);color:var(--green);}
.ltag.hot{border-color:rgba(255,77,109,0.4);color:var(--red);}
.ltag.contacted{border-color:rgba(232,184,64,0.3);color:var(--gold);}

/* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
.chat-area{display:flex;flex-direction:column;overflow:hidden;background:var(--bg);}

/* Contact header bar */
.chat-bar{
  padding:12px 20px;border-bottom:1px solid var(--b1);
  display:flex;align-items:center;justify-content:space-between;
  background:var(--panel);flex-shrink:0;
  box-shadow:0 1px 0 rgba(255,255,255,0.04);
}
.cb-l{display:flex;align-items:center;gap:12px;}
.cb-av{
  width:36px;height:36px;border-radius:50%;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  display:flex;align-items:center;justify-content:center;
  font-size:0.75rem;font-weight:700;color:#03050e;
  font-family:'JetBrains Mono',monospace;flex-shrink:0;
}
.cb-info{display:flex;flex-direction:column;gap:2px;}
.cb-name{font-size:0.88rem;font-weight:700;line-height:1;}
.cb-meta{font-family:'JetBrains Mono',monospace;font-size:0.43rem;color:var(--muted);margin-top:2px;}
.cb-r{display:flex;gap:6px;}
.cb-btn{
  padding:5px 12px;border:1px solid var(--b1);background:transparent;
  color:var(--muted);font-family:'JetBrains Mono',monospace;
  font-size:0.43rem;letter-spacing:0.08em;cursor:pointer;transition:all 0.2s;
}
.cb-btn:hover{color:var(--gold);border-color:var(--gold-dim);}
.cb-btn.red{border-color:rgba(255,77,109,0.25);color:var(--red);}
.cb-btn.red:hover{background:rgba(255,77,109,0.08);}

/* Messages area ‚Äî like Telegram */
.msgs-area{
  flex:1;overflow-y:auto;
  padding:20px 24px;
  display:flex;flex-direction:column;gap:4px;
  background:var(--bg);
}
.msgs-area::-webkit-scrollbar{width:4px;}
.msgs-area::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:2px;}

/* Date separator */
.msg-date-sep{
  text-align:center;margin:10px 0 6px;
  font-family:'JetBrains Mono',monospace;font-size:0.42rem;
  letter-spacing:0.12em;color:var(--muted);
  display:flex;align-items:center;gap:10px;
}
.msg-date-sep::before,.msg-date-sep::after{content:'';flex:1;border-top:1px solid var(--b1);}

/* Message wrapper */
.msg-row{display:flex;flex-direction:column;margin-bottom:2px;}
.msg-row.bot  .msg-wrap{align-items:flex-start;}
.msg-row.user .msg-wrap{align-items:flex-end;}
.msg-row.admin .msg-wrap{align-items:flex-end;}

.msg-wrap{display:flex;flex-direction:column;max-width:72%;}

/* Sender label */
.msg-who{
  font-family:'JetBrains Mono',monospace;font-size:0.41rem;
  letter-spacing:0.08em;margin-bottom:3px;padding:0 4px;
}
.msg-who.lbl-bot{color:var(--gold);}
.msg-who.lbl-user{color:var(--muted);text-align:right;}
.msg-who.lbl-admin{color:var(--cyan);text-align:right;}

/* Bubble */
.msg-bubble{
  padding:10px 14px;font-size:0.82rem;line-height:1.65;
  word-break:break-word;position:relative;
}
.msg-bubble.bot{
  background:var(--panel);
  border:1px solid var(--b1);
  border-radius:2px 12px 12px 12px;
  color:var(--text);
}
.msg-bubble.user{
  background:rgba(232,184,64,0.08);
  border:1px solid rgba(232,184,64,0.15);
  border-radius:12px 2px 12px 12px;
  color:var(--text);
  text-align:left;
}
.msg-bubble.admin{
  background:rgba(48,220,255,0.07);
  border:1px solid rgba(48,220,255,0.18);
  border-radius:12px 2px 12px 12px;
  color:var(--text);
}

/* Time inside bubble */
.msg-time{
  display:block;
  font-family:'JetBrains Mono',monospace;font-size:0.4rem;
  color:var(--muted);margin-top:5px;
  text-align:right;
}

/* Typing indicator */
.typing-row{display:flex;align-items:center;gap:6px;padding:6px 0;}
.typing-dots{display:flex;gap:4px;align-items:center;background:var(--panel);border:1px solid var(--b1);padding:8px 14px;border-radius:2px 12px 12px 12px;}
.td{width:5px;height:5px;border-radius:50%;background:var(--gold);animation:tdot 1.2s infinite;}
.td:nth-child(2){animation-delay:0.2s;}
.td:nth-child(3){animation-delay:0.4s;}
@keyframes tdot{0%,80%,100%{opacity:0.2;transform:scale(0.7);}40%{opacity:1;transform:scale(1);}}

/* Input area */
.input-area{
  padding:12px 20px;border-top:1px solid var(--b1);
  display:flex;gap:10px;align-items:flex-end;
  background:var(--panel);flex-shrink:0;
}
.inp-wrap{
  flex:1;display:flex;align-items:center;
  background:rgba(0,0,0,0.35);border:1px solid var(--b1);
  transition:border-color 0.2s;
}
.inp-wrap:focus-within{border-color:rgba(232,184,64,0.25);}
.chat-inp{
  flex:1;padding:10px 14px;
  background:transparent;border:none;
  color:var(--text);font-family:'Syne',sans-serif;font-size:0.82rem;
  outline:none;resize:none;height:40px;max-height:120px;
}
.chat-inp::placeholder{color:var(--muted);}
.send-btn{
  padding:10px 20px;height:40px;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  border:none;color:#03050e;
  font-family:'JetBrains Mono',monospace;font-size:0.52rem;
  font-weight:700;letter-spacing:0.08em;
  cursor:pointer;transition:all 0.2s;white-space:nowrap;
  clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,6px 100%,0 calc(100% - 6px));
}
.send-btn:hover{box-shadow:0 0 16px rgba(232,184,64,0.3);}

/* RIGHT PANEL */
.right-panel{border-left:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;}
.rp-tabs{display:flex;border-bottom:1px solid var(--b1);flex-shrink:0;}
.rp-tab{flex:1;padding:11px 6px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:0.45rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);cursor:pointer;background:var(--panel);border-bottom:2px solid transparent;transition:all 0.2s;}
.rp-tab:hover{color:var(--text);}
.rp-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.rp-body{flex:1;overflow-y:auto;padding:14px;}
.rp-body::-webkit-scrollbar{width:3px;}
.rp-body::-webkit-scrollbar-thumb{background:var(--b2);}

.ld-section{margin-bottom:16px;}
.ld-lbl{font-family:'JetBrains Mono',monospace;font-size:0.44rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.ld-val{font-size:0.8rem;font-weight:600;margin-bottom:3px;}
.ld-sm{font-size:0.72rem;color:var(--muted);}
.ld-div{border:none;border-top:1px solid var(--b1);margin:12px 0;}
.status-btns{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px;}
.sb{padding:4px 10px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.43rem;cursor:pointer;transition:all 0.2s;}
.sb:hover{color:var(--gold);border-color:var(--gold-dim);}
.sb.s-new{border-color:rgba(29,245,154,0.4);color:var(--green);}
.sb.s-hot{border-color:rgba(255,77,109,0.4);color:var(--red);}
.sb.s-done{border-color:rgba(232,184,64,0.3);color:var(--gold);}
.note-area{width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'Syne',sans-serif;font-size:0.75rem;resize:vertical;min-height:70px;outline:none;margin-top:6px;}
.note-area:focus{border-color:var(--gold-dim);}
.save-btn{width:100%;margin-top:6px;padding:7px;background:var(--gold-dim);border:1px solid var(--gold-dim);color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:0.45rem;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;}
.save-btn:hover{background:rgba(232,184,64,0.15);}
.action-btn{width:100%;margin-top:5px;padding:7px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.43rem;cursor:pointer;transition:all 0.2s;text-align:left;}
.action-btn:hover{color:var(--gold);border-color:var(--gold-dim);}

.sg-title{font-family:'JetBrains Mono',monospace;font-size:0.48rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);margin-bottom:8px;margin-top:16px;}
.sg-title:first-child{margin-top:0;}
.sg-title::before{content:'// ';opacity:0.4;}
.ctx-area{width:100%;padding:9px;background:rgba(0,0,0,0.4);border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.62rem;line-height:1.7;resize:vertical;min-height:130px;outline:none;margin-top:6px;}
.ctx-area:focus{border-color:var(--gold-dim);}
.sel-fi{width:100%;padding:6px 8px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.52rem;outline:none;cursor:pointer;margin-top:6px;}
.sel-fi:focus{border-color:var(--gold-dim);}
option{background:#08101f;}
.save-ctx{width:100%;margin-top:6px;padding:8px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;color:#03050e;font-family:'JetBrains Mono',monospace;font-size:0.48rem;font-weight:700;cursor:pointer;}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--b1);}
.toggle-row:last-child{border-bottom:none;}
.tr-lbl{font-size:0.75rem;font-weight:600;}
.tr-sub{font-family:'JetBrains Mono',monospace;font-size:0.42rem;color:var(--muted);margin-top:1px;}
.toggle{width:34px;height:18px;background:var(--b1);border-radius:9px;cursor:pointer;position:relative;border:1px solid var(--b2);transition:all 0.3s;flex-shrink:0;}
.toggle.on{background:rgba(29,245,154,0.15);border-color:rgba(29,245,154,0.35);}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:var(--muted);transition:all 0.3s;}
.toggle.on::after{left:18px;background:var(--green);}
.int-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--b1);}
.int-row:last-child{border-bottom:none;}
.int-lbl{font-size:0.75rem;font-weight:600;}
.int-sub{font-family:'JetBrains Mono',monospace;font-size:0.42rem;margin-top:1px;}
.int-sub.ok{color:var(--green);}
.int-sub.err{color:var(--red);}
.int-btn{padding:3px 10px;border:1px solid var(--b1);background:transparent;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.42rem;cursor:pointer;}
.int-btn.ok-btn{border-color:rgba(29,245,154,0.3);color:var(--green);}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--muted);}
.empty-ico{font-size:2rem;opacity:0.25;}
.empty-txt{font-family:'JetBrains Mono',monospace;font-size:0.52rem;letter-spacing:0.1em;}

/* NOTIF */
.notif{position:fixed;bottom:18px;right:18px;z-index:999;padding:10px 16px;background:var(--panel);border:1px solid var(--green);color:var(--green);font-family:'JetBrains Mono',monospace;font-size:0.52rem;letter-spacing:0.08em;animation:slideIn 0.3s ease;max-width:260px;}
.notif.err{border-color:var(--red);color:var(--red);}
@keyframes slideIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

.new-badge{display:inline-block;background:var(--green);color:#03050e;font-family:'JetBrains Mono',monospace;font-size:0.38rem;font-weight:700;padding:2px 5px;margin-left:6px;vertical-align:middle;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.5;}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   OFFICE PAGE ‚Äî TOP-DOWN PIXEL ART
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#page-office{
  height:calc(100vh - 52px);
  margin-top:52px;
  flex-direction:row;
  background:var(--bg);
  overflow:hidden;
  display:none;
}
/* –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –æ—Ñ–∏—Å–∞ */
.td-map{
  flex:1;
  position:relative;
  overflow:hidden;
  background:#0c1525;
  cursor:default;
  image-rendering:pixelated;
}
/* –í–Ω–µ—à–Ω–∏–µ —Å—Ç–µ–Ω—ã */
.td-map::before{
  content:'';
  position:absolute;
  inset:20px;
  border:3px solid #1e2d50;
  background:transparent;
  pointer-events:none;
  z-index:5;
  box-shadow:inset 0 0 0 1px #0a1020;
}
/* –ü–æ–ª —Ä–∞–±–æ—á–µ–π –∑–æ–Ω—ã ‚Äî –ø–ª–∏—Ç–∫–∞ */
.td-floor-work{
  position:absolute;
  top:20px;left:20px;
  width:60%;
  bottom:20px;
  background:
    repeating-linear-gradient(90deg, rgba(30,45,80,0.4) 0px, rgba(30,45,80,0.4) 1px, transparent 1px, transparent 40px),
    repeating-linear-gradient(0deg, rgba(30,45,80,0.4) 0px, rgba(30,45,80,0.4) 1px, transparent 1px, transparent 40px),
    #0f1a30;
}
/* –ü–æ–ª –ª–∞—É–Ω–∂–∞ ‚Äî –ø–∞—Ä–∫–µ—Ç */
.td-floor-lounge{
  position:absolute;
  top:20px;right:20px;
  width:calc(40% - 3px);
  bottom:20px;
  background:
    repeating-linear-gradient(90deg, rgba(60,40,20,0.3) 0px, rgba(60,40,20,0.3) 1px, transparent 1px, transparent 48px),
    repeating-linear-gradient(0deg, rgba(60,40,20,0.2) 0px, rgba(60,40,20,0.2) 1px, transparent 1px, transparent 24px),
    #1a1208;
}
/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–µ–Ω–∞ */
.td-wall-divider{
  position:absolute;
  top:20px;bottom:20px;
  left:calc(60% + 20px);
  width:4px;
  background:#1e2d50;
  z-index:4;
}
.td-wall-divider::after{
  content:'';
  position:absolute;
  top:35%;bottom:35%;
  left:0;right:0;
  background:#0c1525;
}
/* ‚îÄ‚îÄ –ú–ï–ë–ï–õ–¨ (top-down –≤–∏–¥) ‚îÄ‚îÄ */
.td-obj{
  position:absolute;
  image-rendering:pixelated;
}
/* –°—Ç–æ–ª —Ä–∞–±–æ—á–∏–π ‚Äî –≤–∏–¥ —Å–≤–µ—Ä—Ö—É */
.td-desk{
  width:72px;height:44px;
  background:#1c2d50;
  border:2px solid #2a3f70;
  border-radius:2px;
  box-shadow:2px 3px 0 #0a1525;
}
.td-desk::after{
  content:'';
  position:absolute;
  top:6px;left:8px;right:8px;bottom:6px;
  background:#0d1830;
  border:1px solid #223060;
  border-radius:1px;
}
/* –ú–æ–Ω–∏—Ç–æ—Ä –Ω–∞ —Å—Ç–æ–ª–µ */
.td-monitor{
  position:absolute;
  width:28px;height:18px;
  background:#050e1f;
  border:2px solid #30dcff;
  border-radius:1px;
  overflow:hidden;
}
.td-monitor-screen{
  position:absolute;
  inset:2px;
  display:flex;flex-direction:column;gap:2px;padding:1px;
}
.td-mline{
  height:2px;border-radius:1px;
  background:var(--green);opacity:0.6;
}
/* –ö—Ä–µ—Å–ª–æ ‚Äî –≤–∏–¥ —Å–≤–µ—Ä—Ö—É */
.td-chair{
  width:22px;height:22px;
  background:#0d1520;
  border:2px solid #1a2540;
  border-radius:3px;
  box-shadow:1px 2px 0 #060c18;
}
.td-chair::after{
  content:'';
  position:absolute;
  top:3px;left:3px;right:3px;bottom:3px;
  background:#111e35;
  border-radius:2px;
}
/* –î–∏–≤–∞–Ω ‚Äî –≤–∏–¥ —Å–≤–µ—Ä—Ö—É */
.td-sofa{
  width:100px;height:32px;
  background:#1a2545;
  border:2px solid #253560;
  border-radius:3px;
  box-shadow:2px 3px 0 #0a1020;
}
.td-sofa::before{
  content:'';
  position:absolute;
  top:4px;left:4px;right:4px;bottom:4px;
  background:#1e2e55;
  border-radius:2px;
  border:1px solid #2a3e6a;
}
/* –ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞ */
.td-coffee{
  width:28px;height:28px;
  background:#1a0808;
  border:2px solid #cc4400;
  border-radius:2px;
}
.td-coffee::after{
  content:'‚òï';
  position:absolute;
  inset:0;
  display:flex;align-items:center;justify-content:center;
  font-size:0.75rem;
}
/* –†–∞—Å—Ç–µ–Ω–∏–µ */
.td-plant{
  width:22px;height:22px;
  background:#0a1f0a;
  border:2px solid #1a4010;
  border-radius:50%;
}
.td-plant::after{
  content:'üåø';
  position:absolute;
  inset:0;
  display:flex;align-items:center;justify-content:center;
  font-size:0.6rem;
}
/* –ü–æ–ª–∫–∞ */
.td-shelf{
  width:80px;height:14px;
  background:#1c2540;
  border:1px solid #2a3560;
  border-radius:1px;
}
.td-shelf::after{
  content:'';
  position:absolute;
  top:2px;left:6px;right:6px;bottom:2px;
  background:repeating-linear-gradient(90deg, #e85 0,#e85 6px, #8a4 7px,#8a4 12px, #44c 13px,#44c 18px, #0d1830 19px,#0d1830 22px);
  border-radius:1px;
}
/* –ó–Ω–∞–∫ LABS67 –Ω–∞ —Å—Ç–µ–Ω–µ */
.td-sign{
  position:absolute;
  top:28px;right:32px;
  font-family:'JetBrains Mono',monospace;
  font-size:0.55rem;
  font-weight:700;
  letter-spacing:0.2em;
  color:var(--gold);
  opacity:0.7;
  text-shadow:0 0 8px rgba(232,184,64,0.4);
  z-index:6;
}
/* –ü–æ—Ç–æ–ª–æ—á–Ω—ã–µ –ª–∞–º–ø—ã */
.td-lamp{
  position:absolute;
  width:8px;height:8px;
  background:rgba(232,184,64,0.8);
  border-radius:50%;
  box-shadow:0 0 20px 10px rgba(232,184,64,0.06);
  z-index:3;
}

/* ‚îÄ‚îÄ –ü–ò–ö–°–ï–õ–¨–ù–´–ô –ü–ï–†–°–û–ù–ê–ñ (top-down) ‚îÄ‚îÄ */
.td-agent{
  position:absolute;
  z-index:10;
  display:flex;flex-direction:column;
  align-items:center;
  gap:1px;
  transition:left 0.8s cubic-bezier(.4,0,.2,1), top 0.8s cubic-bezier(.4,0,.2,1);
  cursor:pointer;
}
/* –¢–µ–Ω—å –ø–æ–¥ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º */
.td-shadow{
  width:22px;height:6px;
  background:rgba(0,0,0,0.4);
  border-radius:50%;
  margin-top:-2px;
}
/* –ú–∞—Ä–∫–µ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ */
.td-marker{
  position:absolute;
  bottom:-4px;
  width:28px;height:8px;
  border-radius:50%;
  opacity:0;
  transition:opacity 0.3s;
}
.td-agent.active .td-marker{ opacity:1; animation:markerPulse 1.5s infinite; }
@keyframes markerPulse{0%,100%{transform:scaleX(1);}50%{transform:scaleX(1.15);}}

/* –¢–µ–ª–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–≤–∏–¥ —Å–≤–µ—Ä—Ö—É/—Å–∑–∞–¥–∏ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π RPG —Å—Ç–∏–ª—å) */
.td-body{
  position:relative;
  width:16px;height:20px;
}
/* –ì–æ–ª–æ–≤–∞ */
.td-head{
  position:absolute;
  top:0;left:50%;transform:translateX(-50%);
  width:14px;height:13px;
  border-radius:3px 3px 2px 2px;
}
/* –¢–µ–ª–æ */
.td-torso{
  position:absolute;
  top:11px;left:50%;transform:translateX(-50%);
  width:12px;height:9px;
  border-radius:1px;
}
/* –ò–∫–æ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π */
.td-status-ico{
  position:absolute;
  top:-20px;left:50%;transform:translateX(-50%);
  font-size:0.75rem;
  filter:drop-shadow(0 1px 3px rgba(0,0,0,0.8));
  animation:icoFloat 2s ease-in-out infinite;
}
@keyframes icoFloat{0%,100%{transform:translateX(-50%) translateY(0);}50%{transform:translateX(-50%) translateY(-3px);}}
/* –ü—É–∑—ã—Ä—å */
.td-bubble{
  display:none;
  position:absolute;
  top:-32px;left:50%;transform:translateX(-50%);
  background:#0f1830;
  border:1px solid var(--cyan);
  border-radius:6px 6px 6px 2px;
  padding:3px 7px;
  font-family:'JetBrains Mono',monospace;
  font-size:0.45rem;
  color:var(--cyan);
  white-space:nowrap;
  z-index:20;
}
[data-state="talking"] .td-bubble{display:block;animation:bubblePop 0.5s infinite alternate;}
@keyframes bubblePop{from{transform:translateX(-50%) scale(1);}to{transform:translateX(-50%) scale(1.04);}}
/* –ü–∞—Ä –∫–æ—Ñ–µ */
.td-steam{
  display:none;
  position:absolute;
  top:-18px;left:50%;transform:translateX(-50%);
  gap:2px;
}
[data-state="coffee"] .td-steam{display:flex;}
.td-steam-p{width:2px;height:6px;background:rgba(220,220,220,0.35);border-radius:1px;animation:tdSteam 1s infinite;}
.td-steam-p:nth-child(2){animation-delay:.33s;}
.td-steam-p:nth-child(3){animation-delay:.66s;}
@keyframes tdSteam{0%{opacity:.35;transform:translateY(0);}100%{opacity:0;transform:translateY(-8px);}}
/* ZZZ */
.td-zzz{
  display:none;
  position:absolute;
  top:-22px;left:50%;transform:translateX(-50%);
  font-family:'JetBrains Mono',monospace;
  font-size:0.5rem;
  color:#888;
  animation:tdZzz 2s infinite;
}
[data-state="idle"] .td-zzz{display:block;}
@keyframes tdZzz{0%{opacity:1;transform:translateX(-50%) translateY(0);}100%{opacity:0;transform:translateX(-50%) translateY(-14px);}}

/* –ò–º—è —Ç–µ–≥ */
.td-nametag{
  background:rgba(3,5,14,0.85);
  border:1px solid var(--b1);
  border-radius:2px;
  padding:2px 6px;
  font-family:'JetBrains Mono',monospace;
  font-size:0.38rem;
  letter-spacing:0.08em;
  white-space:nowrap;
  margin-top:2px;
}
/* –ê–Ω–∏–º–∞—Ü–∏–∏ —Ö–æ–¥—å–±—ã */
@keyframes walkBob{0%,100%{transform:translateY(0);}50%{transform:translateY(-2px);}}
.td-agent[data-state="working"] .td-body{animation:workBob 0.25s infinite alternate;}
@keyframes workBob{from{transform:translateX(-50%) rotate(-1deg);}to{transform:translateX(-50%) rotate(1deg);}}
.td-agent[data-state="coffee"] .td-body{transform:rotate(-5deg);transform-origin:bottom center;}

/* ‚îÄ‚îÄ –õ–ï–ù–¢–ê –°–û–ë–´–¢–ò–ô ‚îÄ‚îÄ */
.td-feed{
  width:280px;
  border-left:1px solid var(--b1);
  display:flex;flex-direction:column;
  background:var(--panel);
  flex-shrink:0;
}
.td-feed-hdr{
  padding:12px 16px;
  border-bottom:1px solid var(--b1);
  font-family:'JetBrains Mono',monospace;
  font-size:0.48rem;letter-spacing:0.2em;
  text-transform:uppercase;color:var(--gold);
}
.td-feed-hdr::before{content:'// ';opacity:0.5;}
.td-feed-list{flex:1;overflow-y:auto;padding:8px 0;}
.td-feed-list::-webkit-scrollbar{width:3px;}
.td-feed-list::-webkit-scrollbar-thumb{background:var(--b2);}
.td-feed-entry{
  padding:7px 14px;
  border-bottom:1px solid rgba(255,255,255,0.04);
  display:flex;gap:8px;align-items:flex-start;
}
.td-feed-entry:hover{background:rgba(255,255,255,0.02);}
.td-ftime{font-family:'JetBrains Mono',monospace;font-size:0.4rem;color:var(--muted);white-space:nowrap;flex-shrink:0;margin-top:2px;}
.td-ftext{font-size:0.7rem;line-height:1.5;color:var(--text);}
.td-ftext .kn{color:var(--cyan);}
.td-ftext .sn{color:var(--green);}

/* ‚îÄ‚îÄ –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ ‚îÄ‚îÄ */
.td-controls{
  position:absolute;
  bottom:0;left:0;right:280px;
  border-top:1px solid var(--b1);
  background:rgba(8,16,31,0.95);
  backdrop-filter:blur(10px);
  padding:8px 20px;
  display:flex;gap:20px;align-items:center;
  z-index:20;
}
.td-ctrl-grp{display:flex;align-items:center;gap:5px;}
.td-ctrl-lbl{font-family:'JetBrains Mono',monospace;font-size:0.43rem;letter-spacing:0.08em;color:var(--muted);}
.td-cbtn{
  padding:3px 9px;
  border:1px solid var(--b1);
  background:transparent;
  color:var(--muted);
  font-family:'JetBrains Mono',monospace;
  font-size:0.4rem;
  cursor:pointer;transition:all 0.15s;
}
.td-cbtn:hover{color:var(--gold);border-color:var(--gold-dim);}
.td-cbtn.on{color:var(--green);border-color:rgba(29,245,154,0.4);background:rgba(29,245,154,0.05);}
.td-cdiv{width:1px;height:24px;background:var(--b1);flex-shrink:0;}

/* –¶–≤–µ—Ç–∞ –ö–ê–ô */
.td-agent.kai .td-head{background:#1a9fc0;}
.td-agent.kai .td-torso{background:#0d6a8a;}
.td-agent.kai .td-marker{background:var(--cyan);box-shadow:0 0 8px var(--cyan);}
.td-agent.kai .td-nametag{color:var(--cyan);border-color:rgba(48,220,255,0.3);}
/* –¶–≤–µ—Ç–∞ –°–¢–ï–ü–ê */
.td-agent.stepa .td-head{background:#15b870;}
.td-agent.stepa .td-torso{background:#0d7a4a;}
.td-agent.stepa .td-marker{background:var(--green);box-shadow:0 0 8px var(--green);}
.td-agent.stepa .td-nametag{color:var(--green);border-color:rgba(29,245,154,0.3);}

/* –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º office-controls (—Å–∫—Ä—ã–≤–∞–µ–º) */
.office-controls,.office-wrap,.office-room,.office-feed,.office-floor,.office-wall,
.ceiling-light,.agent-station,.desk,.monitor,.character,.char-overhead,.char-label,
.ctrl-group,.ctrl-divider,.ctrl-btn{display:none !important;}
</style>
</head>
<body>

<div class="topbar">
  <div class="tb-logo">
    <div class="tb-mark">L67</div>
    <div>
      <div class="tb-name"><em>LABS</em>67</div>
    </div>
    <div class="tb-badge">ADMIN PANEL</div>
  </div>
  <div class="tb-nav">
    <button class="tb-tab active" onclick="showPage('crm',this)">üí¨ CRM</button>
    <button class="tb-tab" onclick="showPage('bot',this)">‚öôÔ∏è –ë–æ—Ç</button>
    <button class="tb-tab" onclick="showPage('logs',this)">ü§ñ –õ–æ–≥–∏</button>
    <button class="tb-tab" onclick="showPage('office',this)">üè¢ –û—Ñ–∏—Å</button>
  </div>
  <div class="tb-r">
    <div class="tb-status"><div class="tb-dot"></div><span id="dbStatus">CONNECTING...</span></div>
    <span class="tb-time" id="clock"></span>
  </div>
</div>

<div id="page-crm" class="layout">

  <!-- COL 1: LEADS -->
  <div class="pane">
    <div class="pane-hdr">
      <span class="pane-title">// –ó–∞—è–≤–∫–∏</span>
      <span class="pane-count" id="leadCount">0</span>
    </div>
    <div class="stats-bar">
      <div class="stat-item"><span class="stat-num" id="sNew">0</span><span class="stat-lbl">–ù–æ–≤—ã–µ</span></div>
      <div class="stat-item"><span class="stat-num" style="color:var(--red)" id="sHot">0</span><span class="stat-lbl">–ì–æ—Ä—è—á–∏–µ</span></div>
      <div class="stat-item"><span class="stat-num" style="color:var(--green)" id="sDone">0</span><span class="stat-lbl">–ó–∞–∫—Ä—ã—Ç—ã</span></div>
    </div>
    <div class="filter-bar">
      <button class="fb active" onclick="setFilter('all',this)">–í—Å–µ</button>
      <button class="fb" onclick="setFilter('dental',this)">Dental</button>
      <button class="fb" onclick="setFilter('trade',this)">Trade</button>
      <button class="fb" onclick="setFilter('academi',this)">Academi</button>
      <button class="fb" onclick="setFilter('franchise',this)">Franchise</button>
    </div>
    <div class="pane-body" id="leadsList">
      <div class="empty"><div class="empty-ico">üìã</div><div class="empty-txt">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div></div>
    </div>
  </div>

  <!-- COL 2: CHAT -->
  <div class="chat-area">
    <div class="chat-bar" id="chatBar" style="display:none;">
      <div class="cb-l">
        <div class="cb-av" id="chatAv">?</div>
        <div class="cb-info">
          <div class="cb-name" id="chatName">‚Äî</div>
          <div class="cb-meta" id="chatMeta">‚Äî</div>
        </div>
      </div>
      <div class="cb-r">
        <button class="cb-btn" onclick="setStatus('contacted')">‚úì Contacted</button>
        <button class="cb-btn" onclick="setStatus('hot')">üî• Hot</button>
        <button class="cb-btn red" onclick="setStatus('done')">‚úï Archive</button>
      </div>
    </div>
    <div class="msgs-area" id="msgsArea">
      <div class="empty"><div class="empty-ico">üí¨</div><div class="empty-txt">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É —Å–ª–µ–≤–∞</div></div>
    </div>
    <div class="input-area" id="inputArea" style="display:none;">
      <div class="inp-wrap">
        <textarea class="chat-inp" id="adminInp" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç –∏–º–µ–Ω–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAdminMsg();}"></textarea>
      </div>
      <button class="send-btn" onclick="sendAdminMsg()">‚Üí SEND</button>
    </div>
  </div>

  <!-- COL 3: RIGHT -->
  <div class="right-panel">
    <div class="rp-tabs">
      <div class="rp-tab active" onclick="rpTab('detail',this)">–ó–∞—è–≤–∫–∞</div>
      <div class="rp-tab" onclick="rpTab('context',this)">AI –ö–æ–Ω—Ç–µ–∫—Å—Ç</div>
      <div class="rp-tab" onclick="rpTab('settings',this)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>
    <div class="rp-body" id="rpBody">
      <div class="empty" style="height:200px;"><div class="empty-ico">üìã</div><div class="empty-txt">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</div></div>
    </div>
  </div>

</div>

<!-- PAGE 2: –ë–û–¢ -->
<div id="page-bot" style="display:none;height:calc(100vh - 52px);margin-top:52px;display:none;grid-template-columns:350px 1fr;gap:0;background:var(--bg);">
  <div style="border-right:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;">
    <div class="pane-hdr"><span class="pane-title">// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</span></div>
    <div style="padding:20px;display:flex;flex-direction:column;gap:16px;overflow-y:auto;flex:1;">
      <div><label style="font-family:'JetBrains Mono',monospace;font-size:0.48rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:6px;">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</label><textarea style="width:100%;padding:10px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'Syne',sans-serif;font-size:0.84rem;outline:none;resize:vertical;min-height:120px;" placeholder="–í—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç LABS67. –ü–æ–º–æ–≥–∞–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º –≤—ã–±—Ä–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."></textarea></div>
      <div><label style="font-family:'JetBrains Mono',monospace;font-size:0.48rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:6px;">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label><input type="text" style="width:100%;padding:10px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'Syne',sans-serif;font-size:0.84rem;outline:none;" value="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"></div>
      <div><label style="font-family:'JetBrains Mono',monospace;font-size:0.48rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:6px;">–ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞ (–º—Å)</label><input type="number" style="width:100%;padding:10px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'Syne',sans-serif;font-size:0.84rem;outline:none;" value="800"></div>
      <button onclick="alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã')" style="padding:12px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;color:#03050e;font-family:'Syne',sans-serif;font-size:0.72rem;font-weight:700;letter-spacing:0.15em;text-transform:uppercase;cursor:pointer;">// –°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
  </div>
  <div style="display:flex;flex-direction:column;overflow:hidden;background:var(--bg2);">
    <div class="pane-hdr"><span class="pane-title" style="color:var(--cyan);">// –†–ï–ñ–ò–ú –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø</span></div>
    <div id="bot-msgs" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;">
      <div style="max-width:80%;padding:10px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--b1);border-radius:0 8px 8px 8px;font-size:0.84rem;align-self:flex-start;"><span style="font-family:'JetBrains Mono',monospace;font-size:0.44rem;color:var(--cyan);display:block;margin-bottom:4px;">// –ë–æ—Ç</span>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    </div>
    <div style="padding:10px;border-top:1px solid var(--b1);display:flex;gap:8px;">
      <input id="bot-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')botSend()" style="flex:1;padding:9px 12px;background:rgba(0,0,0,0.3);border:1px solid var(--b1);color:var(--text);font-family:'Syne',sans-serif;font-size:0.84rem;outline:none;">
      <button onclick="botSend()" style="padding:9px 16px;background:var(--cyan);border:none;color:#03050e;font-weight:700;cursor:pointer;font-size:0.8rem;">‚Üí</button>
    </div>
  </div>
</div>

<!-- PAGE 3: –õ–û–ì–ò -->
<div id="page-logs" style="display:none;height:calc(100vh - 52px);margin-top:52px;display:none;flex-direction:column;background:var(--bg);">
  <div style="padding:10px 16px;border-bottom:1px solid var(--b1);display:flex;gap:10px;align-items:center;background:var(--panel);flex-shrink:0;">
    <select id="log-agent" onchange="renderLogs()" style="padding:6px 10px;background:var(--bg);border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.5rem;outline:none;"><option value="">–í—Å–µ –∞–≥–µ–Ω—Ç—ã</option><option value="–ö–∞–π">–ö–∞–π</option><option value="–°—Ç–µ–ø–∞">–°—Ç–µ–ø–∞</option></select>
    <select id="log-status" onchange="renderLogs()" style="padding:6px 10px;background:var(--bg);border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.5rem;outline:none;"><option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option><option value="success">Success</option><option value="error">Error</option></select>
    <input id="log-date" type="date" onchange="renderLogs()" style="padding:6px 10px;background:var(--bg);border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.5rem;outline:none;">
    <button onclick="document.getElementById('log-agent').value='';document.getElementById('log-status').value='';document.getElementById('log-date').value='';renderLogs();" style="padding:6px 14px;background:transparent;border:1px solid var(--b1);color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.48rem;cursor:pointer;">–°–±—Ä–æ—Å–∏—Ç—å</button>
    <span style="font-family:'JetBrains Mono',monospace;font-size:0.48rem;color:var(--muted);margin-left:auto;">// AGENT LOGS</span>
  </div>
  <div style="flex:1;overflow-y:auto;">
    <table id="log-table" style="width:100%;border-collapse:collapse;">
      <thead><tr style="background:var(--panel);font-family:'JetBrains Mono',monospace;font-size:0.46rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);">
        <th style="padding:10px 14px;text-align:left;border-bottom:1px solid var(--b1);">–í—Ä–µ–º—è</th>
        <th style="padding:10px 14px;text-align:left;border-bottom:1px solid var(--b1);">–ê–≥–µ–Ω—Ç</th>
        <th style="padding:10px 14px;text-align:left;border-bottom:1px solid var(--b1);">–ú–æ–¥–µ–ª—å</th>
        <th style="padding:10px 14px;text-align:left;border-bottom:1px solid var(--b1);">–ó–∞–¥–∞—á–∞</th>
        <th style="padding:10px 14px;text-align:left;border-bottom:1px solid var(--b1);">–°—Ç–∞—Ç—É—Å</th>
        <th style="padding:10px 14px;text-align:left;border-bottom:1px solid var(--b1);">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
        <th style="padding:10px 14px;border-bottom:1px solid var(--b1);"></th>
      </tr></thead>
      <tbody id="log-tbody"></tbody>
    </table>
  </div>
</div>

<!-- PAGE 4: –û–§–ò–° ‚Äî TOP-DOWN -->
<div id="page-office">

  <!-- –ö–∞—Ä—Ç–∞ –æ—Ñ–∏—Å–∞ -->
  <div class="td-map" id="tdMap">

    <!-- –ü–æ–ª—ã -->
    <div class="td-floor-work"></div>
    <div class="td-floor-lounge"></div>

    <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–µ–Ω–∞ —Å –ø—Ä–æ—Ö–æ–¥–æ–º -->
    <div class="td-wall-divider"></div>

    <!-- –ó–Ω–∞–∫ LABS67 -->
    <div class="td-sign">LABS67 HQ</div>

    <!-- –õ–∞–º–ø—ã -->
    <div class="td-lamp" style="top:60px;left:22%"></div>
    <div class="td-lamp" style="top:60px;left:48%"></div>
    <div class="td-lamp" style="top:60px;right:22%"></div>

    <!-- –†–ê–ë–û–ß–ê–Ø –ó–û–ù–ê: –°—Ç–æ–ª –ö–∞—è -->
    <div class="td-obj td-desk" style="top:90px;left:60px;">
      <div class="td-monitor" style="top:6px;left:12px;">
        <div class="td-monitor-screen">
          <div class="td-mline" style="width:90%"></div>
          <div class="td-mline" style="width:60%"></div>
          <div class="td-mline" style="width:80%"></div>
        </div>
      </div>
    </div>
    <div class="td-obj td-chair" style="top:144px;left:85px;"></div>

    <!-- –°—Ç–æ–ª –°—Ç–µ–ø—ã -->
    <div class="td-obj td-desk" style="top:90px;left:200px;">
      <div class="td-monitor" style="top:6px;left:12px;">
        <div class="td-monitor-screen">
          <div class="td-mline" style="width:70%"></div>
          <div class="td-mline" style="width:90%"></div>
          <div class="td-mline" style="width:50%"></div>
        </div>
      </div>
    </div>
    <div class="td-obj td-chair" style="top:144px;left:225px;"></div>

    <!-- –î–æ–ø —Å—Ç–æ–ª -->
    <div class="td-obj td-desk" style="top:220px;left:60px;"></div>
    <div class="td-obj td-chair" style="top:272px;left:85px;"></div>

    <div class="td-obj td-desk" style="top:220px;left:200px;"></div>
    <div class="td-obj td-chair" style="top:272px;left:225px;"></div>

    <!-- –ü–æ–ª–∫–∞ –Ω–∞ —Å—Ç–µ–Ω–µ -->
    <div class="td-obj td-shelf" style="top:36px;left:60px;"></div>
    <div class="td-obj td-shelf" style="top:36px;left:180px;"></div>

    <!-- –†–∞—Å—Ç–µ–Ω–∏—è –≤ —É–≥–ª–∞—Ö —Ä–∞–±–æ—á–µ–π –∑–æ–Ω—ã -->
    <div class="td-obj td-plant" style="top:36px;left:28px;"></div>
    <div class="td-obj td-plant" style="bottom:28px;left:28px;"></div>

    <!-- –õ–ê–£–ù–ñ –∑–æ–Ω–∞: –¥–∏–≤–∞–Ω, –∫–æ—Ñ–µ–º–∞—à–∏–Ω–∞ -->
    <div class="td-obj td-sofa" style="top:100px;right:60px;"></div>
    <div class="td-obj td-plant" style="top:100px;right:170px;"></div>
    <div class="td-obj td-coffee" style="top:200px;right:80px;"></div>
    <div class="td-obj td-plant" style="bottom:40px;right:60px;"></div>
    <div class="td-obj td-plant" style="bottom:40px;right:100px;"></div>

    <!-- –ö–ê–ô -->
    <div class="td-agent kai active" id="td-kai" data-state="working"
         style="left:88px;top:130px;"
         onclick="tdSelectAgent('kai')">
      <div class="td-status-ico" id="td-kai-ico">üíª</div>
      <div class="td-bubble">...</div>
      <div class="td-steam">
        <div class="td-steam-p"></div><div class="td-steam-p"></div><div class="td-steam-p"></div>
      </div>
      <div class="td-zzz">z z z</div>
      <div class="td-body">
        <div class="td-head"></div>
        <div class="td-torso"></div>
      </div>
      <div class="td-marker"></div>
      <div class="td-shadow"></div>
      <div class="td-nametag">‚ö° –ö–ê–ô</div>
    </div>

    <!-- –°–¢–ï–ü–ê -->
    <div class="td-agent stepa" id="td-stepa" data-state="coffee"
         style="left:228px;top:130px;"
         onclick="tdSelectAgent('stepa')">
      <div class="td-status-ico" id="td-stepa-ico">‚òï</div>
      <div class="td-bubble">...</div>
      <div class="td-steam">
        <div class="td-steam-p"></div><div class="td-steam-p"></div><div class="td-steam-p"></div>
      </div>
      <div class="td-zzz">z z z</div>
      <div class="td-body">
        <div class="td-head"></div>
        <div class="td-torso"></div>
      </div>
      <div class="td-marker"></div>
      <div class="td-shadow"></div>
      <div class="td-nametag">üîß –°–¢–ï–ü–ê</div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="td-controls">
      <div class="td-ctrl-grp">
        <span class="td-ctrl-lbl">‚ö° –ö–ê–ô:</span>
        <button class="td-cbtn on" onclick="tdSetState('kai','working',this)">üíª –†–∞–±–æ—Ç–∞–µ—Ç</button>
        <button class="td-cbtn" onclick="tdSetState('kai','coffee',this)">‚òï –ö–æ—Ñ–µ</button>
        <button class="td-cbtn" onclick="tdSetState('kai','talking',this)">üí¨ –ë–æ–ª—Ç–∞–µ—Ç</button>
        <button class="td-cbtn" onclick="tdSetState('kai','idle',this)">üí§ –û—Ç–¥—ã—Ö</button>
      </div>
      <div class="td-cdiv"></div>
      <div class="td-ctrl-grp">
        <span class="td-ctrl-lbl">üîß –°–¢–ï–ü–ê:</span>
        <button class="td-cbtn" onclick="tdSetState('stepa','working',this)">üíª –†–∞–±–æ—Ç–∞–µ—Ç</button>
        <button class="td-cbtn on" onclick="tdSetState('stepa','coffee',this)">‚òï –ö–æ—Ñ–µ</button>
        <button class="td-cbtn" onclick="tdSetState('stepa','talking',this)">üí¨ –ë–æ–ª—Ç–∞–µ—Ç</button>
        <button class="td-cbtn" onclick="tdSetState('stepa','idle',this)">üí§ –û—Ç–¥—ã—Ö</button>
      </div>
    </div>

  </div><!-- /td-map -->

  <!-- –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π -->
  <div class="td-feed">
    <div class="td-feed-hdr">–ü–û–°–õ–ï–î–ù–ò–ï –î–ï–ô–°–¢–í–ò–Ø</div>
    <div class="td-feed-list">
      <div class="td-feed-entry"><span class="td-ftime">04:56</span><span class="td-ftext"><span class="kn">‚ö° –ö–∞–π</span> ‚Üí –ø–µ—Ä–µ–¥–µ–ª–∞–ª –æ—Ñ–∏—Å –≤ top-down —Ä–µ–∂–∏–º</span></div>
      <div class="td-feed-entry"><span class="td-ftime">04:21</span><span class="td-ftext"><span class="kn">‚ö° –ö–∞–π</span> ‚Üí –∑–∞–ø—É—à–∏–ª 3-page SPA admin panel</span></div>
      <div class="td-feed-entry"><span class="td-ftime">04:13</span><span class="td-ftext"><span class="sn">üîß –°—Ç–µ–ø–∞</span> ‚Üí –Ω–∞–ø–∏—Å–∞–ª 126 —Å—Ç—Ä–æ–∫ –æ—Ñ–∏—Å–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏</span></div>
      <div class="td-feed-entry"><span class="td-ftime">04:05</span><span class="td-ftext"><span class="kn">‚ö° –ö–∞–π</span> ‚Üí –Ω–∞—à—ë–ª –±–∞–≥ –≤ —Ñ–æ—Ä–º–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π</span></div>
      <div class="td-feed-entry"><span class="td-ftime">03:58</span><span class="td-ftext"><span class="sn">üîß –°—Ç–µ–ø–∞</span> ‚Üí —É–±—Ä–∞–ª Prefer header, –ø–æ—á–∏—Å—Ç–∏–ª –¥—É–±–ª–∏</span></div>
      <div class="td-feed-entry"><span class="td-ftime">03:47</span><span class="td-ftext"><span class="kn">‚ö° –ö–∞–π</span> ‚Üí –¥–æ–±–∞–≤–∏–ª PWA manifest + apple icons</span></div>
      <div class="td-feed-entry"><span class="td-ftime">03:28</span><span class="td-ftext"><span class="kn">‚ö° –ö–∞–π</span> ‚Üí realtime Supabase –ø–æ–¥–ø–∏—Å–∫–∏</span></div>
      <div class="td-feed-entry"><span class="td-ftime">03:15</span><span class="td-ftext"><span class="sn">üîß –°—Ç–µ–ø–∞</span> ‚Üí CRM chat bubbles —Å—Ç–∏–ª—å</span></div>
      <div class="td-feed-entry"><span class="td-ftime">03:04</span><span class="td-ftext"><span class="kn">‚ö° –ö–∞–π</span> ‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç NBP API</span></div>
      <div class="td-feed-entry"><span class="td-ftime">02:51</span><span class="td-ftext"><span class="sn">üîß –°—Ç–µ–ø–∞</span> ‚Üí email validation regex</span></div>
      <div class="td-feed-entry"><span class="td-ftime">02:47</span><span class="td-ftext"><span class="kn">‚ö° –ö–∞–π</span> ‚Üí —Ñ–∏–∫—Å direction.includes ‚Üí startsWith</span></div>
      <div class="td-feed-entry"><span class="td-ftime">02:33</span><span class="td-ftext"><span class="sn">üîß –°—Ç–µ–ø–∞</span> ‚Üí –ø–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ LABS67</span></div>
    </div>
  </div>

</div><!-- /page-office -->

<script>
// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
const MOCK_LOGS=[
  {id:1,time:'02:47',agent:'–ö–∞–π',model:'sonnet-4.6',task:'fix(form): direction validation',status:'success',cost:'$0.009',detail:'–ë–∞–≥ direction.includes. –§–∏–∫—Å startsWith. –ö–æ–º–º–∏—Ç 2224a32.'},
  {id:2,time:'02:51',agent:'–°—Ç–µ–ø–∞',model:'sonnet-4.6',task:'opt(form): remove Prefer header',status:'success',cost:'$0.003',detail:'–£–±—Ä–∞–Ω Prefer header. –î—É–±–ª—å emailRe —É–¥–∞–ª—ë–Ω. –ö–æ–º–º–∏—Ç fc10ec5.'},
  {id:3,time:'02:55',agent:'–ö–∞–π',model:'sonnet-4.6',task:'–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ admin redesign',status:'success',cost:'$0.007',detail:'3-—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è SPA –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞.'},
  {id:4,time:'03:04',agent:'–°—Ç–µ–ø–∞',model:'sonnet-4.6',task:'PWA manifest + apple-touch-icon',status:'success',cost:'$0.005',detail:'–î–æ–±–∞–≤–ª–µ–Ω manifest.json, apple-mobile-web-app-capable meta —Ç–µ–≥–∏.'}
];

function showPage(name, btn) {
  ['crm','bot','logs','office'].forEach(p => {
    const el = document.getElementById('page-'+p);
    if(el) el.style.display = 'none';
  });
  const target = document.getElementById('page-'+name);
  if(target) {
    if(name==='crm') target.style.display = 'grid';
    else if(name==='logs') target.style.display = 'flex';
    else if(name==='office') target.style.display = 'flex';
    else target.style.display = 'grid';
  }
  document.querySelectorAll('.tb-tab').forEach(t => t.classList.remove('active'));
  if(btn) btn.classList.add('active');
  if(name==='logs') renderLogs();
  if(name==='office') initOffice();
}

function renderLogs() {
  const agent = document.getElementById('log-agent').value;
  const status = document.getElementById('log-status').value;
  const tbody = document.getElementById('log-tbody');
  const filtered = MOCK_LOGS.filter(l =>
    (!agent || l.agent===agent) && (!status || l.status===status)
  );
  tbody.innerHTML = filtered.map(l => `
    <tr style="border-bottom:1px solid var(--b1);font-size:0.82rem;" id="log-row-${l.id}">
      <td style="padding:10px 14px;font-family:'JetBrains Mono',monospace;font-size:0.5rem;color:var(--muted);">${l.time}</td>
      <td style="padding:10px 14px;font-weight:700;color:${l.agent==='–ö–∞–π'?'var(--gold)':'var(--cyan)'};">${l.agent}</td>
      <td style="padding:10px 14px;font-family:'JetBrains Mono',monospace;font-size:0.5rem;color:var(--muted);">${l.model}</td>
      <td style="padding:10px 14px;">${l.task}</td>
      <td style="padding:10px 14px;"><span style="display:inline-flex;align-items:center;gap:5px;font-family:'JetBrains Mono',monospace;font-size:0.48rem;color:${l.status==='success'?'var(--green)':'var(--red)'};">‚óè ${l.status}</span></td>
      <td style="padding:10px 14px;font-family:'JetBrains Mono',monospace;font-size:0.5rem;color:var(--gold);">${l.cost}</td>
      <td style="padding:10px 14px;"><button onclick="toggleDetail(${l.id})" style="background:transparent;border:1px solid var(--b1);color:var(--muted);font-size:0.7rem;cursor:pointer;padding:2px 8px;">‚ñ∂</button></td>
    </tr>
    <tr id="log-detail-${l.id}" style="display:none;background:rgba(255,255,255,0.02);">
      <td colspan="7" style="padding:10px 14px 16px 40px;font-size:0.82rem;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:0.52rem;line-height:1.7;border-bottom:1px solid var(--b1);">${l.detail}</td>
    </tr>
  `).join('');
}

function toggleDetail(id) {
  const row = document.getElementById('log-detail-'+id);
  if(row) row.style.display = row.style.display==='none' ? 'table-row' : 'none';
}

function botSend() {
  const inp = document.getElementById('bot-inp');
  const msgs = document.getElementById('bot-msgs');
  const text = inp.value.trim();
  if(!text) return;
  inp.value = '';
  const userMsg = document.createElement('div');
  userMsg.style.cssText = 'max-width:80%;padding:10px 14px;background:rgba(232,184,64,0.08);border:1px solid rgba(232,184,64,0.2);border-radius:8px 0 8px 8px;font-size:0.84rem;align-self:flex-end;color:var(--gold);margin-left:auto;';
  userMsg.textContent = text;
  msgs.appendChild(userMsg);
  msgs.scrollTop = msgs.scrollHeight;
  setTimeout(() => {
    const botMsg = document.createElement('div');
    botMsg.style.cssText = 'max-width:80%;padding:10px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--b1);border-radius:0 8px 8px 8px;font-size:0.84rem;align-self:flex-start;';
    botMsg.innerHTML = `<span style="font-family:'JetBrains Mono',monospace;font-size:0.44rem;color:var(--cyan);display:block;margin-bottom:4px;">// –ë–æ—Ç</span>// –ë–æ—Ç: ${text}`;
    msgs.appendChild(botMsg);
    msgs.scrollTop = msgs.scrollHeight;
  }, 800);
}

// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const SUPABASE_URL = 'https://ctdleobjnzniqkqomlrq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0ZGxlb2JqbnpuaXFrcW9tbHJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMzE4MTEsImV4cCI6MjA4NzgwNzgxMX0.AMHtY7zGPemKYCxMy2bqRTOEAp8trA_Slor9wmg7C38';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let leads = [];
let currentLead = null;
let currentFilter = 'all';
let currentRpTab = 'detail';
let messages = [];

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
setInterval(() => {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}, 1000);

// ‚îÄ‚îÄ LOAD LEADS ‚îÄ‚îÄ
async function loadLeads() {
  const { data, error } = await sb.from('leads').select('*').order('created_at', {ascending: false});
  if (error) { notify('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫', true); return; }
  leads = data || [];
  document.getElementById('dbStatus').textContent = 'DB ONLINE';
  renderLeads();
}

// ‚îÄ‚îÄ RENDER LEADS ‚îÄ‚îÄ
function renderLeads() {
  const filtered = currentFilter === 'all' ? leads : leads.filter(l => l.source === currentFilter);
  document.getElementById('leadCount').textContent = filtered.length;
  document.getElementById('sNew').textContent = leads.filter(l=>l.status==='new').length;
  document.getElementById('sHot').textContent = leads.filter(l=>l.status==='hot').length;
  document.getElementById('sDone').textContent = leads.filter(l=>l.status==='done').length;

  const list = document.getElementById('leadsList');
  if (!filtered.length) {
    list.innerHTML = '<div class="empty" style="height:200px;"><div class="empty-ico">üì≠</div><div class="empty-txt">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div></div>';
    return;
  }

  list.innerHTML = filtered.map(l => {
    const time = new Date(l.created_at).toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
    const date = new Date(l.created_at).toLocaleDateString('ru-RU', {day:'2-digit',month:'2-digit'});
    const isSelected = currentLead?.id === l.id;
    const tags = [];
    if (l.status === 'new') tags.push('<span class="ltag new">–Ω–æ–≤—ã–π</span>');
    if (l.status === 'hot') tags.push('<span class="ltag hot">üî• –≥–æ—Ä—è—á–∏–π</span>');
    if (l.status === 'contacted') tags.push('<span class="ltag contacted">contacted</span>');
    return `
      <div class="lead-item ${isSelected?'selected':''}" onclick="openLead('${l.id}')">
        <div class="li-top">
          <span class="li-name">${l.name || '–ê–Ω–æ–Ω–∏–º'}</span>
          <span class="li-time">${time} ¬∑ ${date}</span>
        </div>
        <div class="li-src ${l.source||'main'}">${(l.source||'main').toUpperCase()}</div>
        <div class="li-preview">${l.message || '‚Äî'}</div>
        <div class="li-tags">${tags.join('')}</div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ OPEN LEAD ‚îÄ‚îÄ
async function openLead(id) {
  currentLead = leads.find(l => l.id === id);
  if (!currentLead) return;
  renderLeads();

  const initials = (currentLead.name || '??').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('chatBar').style.display = 'flex';
  document.getElementById('inputArea').style.display = 'flex';
  document.getElementById('chatAv').textContent = initials;
  document.getElementById('chatName').textContent = currentLead.name || '–ê–Ω–æ–Ω–∏–º';
  document.getElementById('chatMeta').textContent = `${currentLead.phone||''} ¬∑ ${currentLead.email||''} ¬∑ ${(currentLead.source||'main').toUpperCase()}`;

  // Load messages
  const { data } = await sb.from('chat_messages').select('*').eq('lead_id', id).order('created_at', {ascending: true});
  messages = data || [];
  renderMsgs();

  if (currentRpTab === 'detail') renderDetail();
}

// ‚îÄ‚îÄ RENDER MSGS ‚îÄ‚îÄ
function renderMsgs() {
  const area = document.getElementById('msgsArea');
  if (!messages.length) {
    area.innerHTML = '<div class="empty"><div class="empty-ico">üí¨</div><div class="empty-txt">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div></div>';
    return;
  }
  // Group by date
  let lastDate = '';
  area.innerHTML = messages.map(m => {
    const dt = new Date(m.created_at);
    const time = dt.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
    const dateStr = dt.toLocaleDateString('ru-RU', {day:'2-digit',month:'long'});
    const cls = m.role || 'user';
    const isBot = cls === 'bot';
    const isAdmin = cls === 'admin';
    let dateSep = '';
    if (dateStr !== lastDate) { lastDate = dateStr; dateSep = `<div class="msg-date-sep">${dateStr}</div>`; }
    const whoLabel = isBot ? '// LABS67 AI' : isAdmin ? '// Manager' : '// Client';
    const whoClass = isBot ? 'lbl-bot' : isAdmin ? 'lbl-admin' : 'lbl-user';
    return `${dateSep}
      <div class="msg-row ${cls}">
        <div class="msg-wrap">
          <span class="msg-who ${whoClass}">${whoLabel}</span>
          <div class="msg-bubble ${cls}">${m.text}<span class="msg-time">${time}</span></div>
        </div>
      </div>`;
  }).join('');
  area.scrollTop = area.scrollHeight;
}

// ‚îÄ‚îÄ SEND ADMIN MSG ‚îÄ‚îÄ
async function sendAdminMsg() {
  const inp = document.getElementById('adminInp');
  const text = inp.value.trim();
  if (!text || !currentLead) return;
  inp.value = '';

  const { error } = await sb.from('chat_messages').insert({
    lead_id: currentLead.id,
    role: 'admin',
    text,
    session_id: 'admin'
  });
  if (error) { notify('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', true); return; }
  const { data } = await sb.from('chat_messages').select('*').eq('lead_id', currentLead.id).order('created_at', {ascending: true});
  messages = data || [];
  renderMsgs();
}

// ‚îÄ‚îÄ SET STATUS ‚îÄ‚îÄ
async function setStatus(status) {
  if (!currentLead) return;
  await sb.from('leads').update({status}).eq('id', currentLead.id);
  currentLead.status = status;
  leads = leads.map(l => l.id === currentLead.id ? {...l, status} : l);
  renderLeads();
  if (currentRpTab === 'detail') renderDetail();
  notify(`–°—Ç–∞—Ç—É—Å ‚Üí ${status}`);
}

// ‚îÄ‚îÄ RP TABS ‚îÄ‚îÄ
function rpTab(tab, btn) {
  currentRpTab = tab;
  document.querySelectorAll('.rp-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const body = document.getElementById('rpBody');
  if (tab === 'detail') {
    if (currentLead) renderDetail();
    else body.innerHTML = '<div class="empty" style="height:200px;"><div class="empty-ico">üìã</div><div class="empty-txt">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</div></div>';
  } else if (tab === 'context') {
    body.innerHTML = `
      <div class="sg-title">–°–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</div>
      <textarea class="ctx-area" id="ctxArea">–í—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–Ω—Ü–µ—Ä–Ω–∞ LABS67. –ü–æ–º–æ–≥–∞–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏: DentalAI (—É–º–Ω—ã–µ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏), Academi67 (–æ–±—É—á–µ–Ω–∏–µ –≤—Ä–∞—á–µ–π), TradeAI (–º–µ–¥—Ç–µ—Ö —Ä–µ—à–µ–Ω–∏—è), Franchise67 (–ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ).

–°—Ç–∏–ª—å: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Ç—ë–ø–ª—ã–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π. –ë–µ–∑ —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑.

–¶–µ–ª—å: –ø–æ–Ω—è—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ ‚Üí –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –æ —à–∞–≥–µ.

–ö–æ–Ω—Ç–∞–∫—Ç—ã: hello@labs67.com, +48 571 719 800</textarea>
      <button class="save-ctx" onclick="notify('–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì')">// –°–û–•–†–ê–ù–ò–¢–¨ –ö–û–ù–¢–ï–ö–°–¢</button>
      <div class="sg-title">–¢–æ–Ω –æ–±—â–µ–Ω–∏—è</div>
      <select class="sel-fi"><option>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π + —Ç—ë–ø–ª—ã–π</option><option>–°—Ç—Ä–æ–≥–æ –¥–µ–ª–æ–≤–æ–π</option><option>–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option><option>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç</option></select>
      <div class="sg-title">–Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
      <select class="sel-fi"><option>–ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</option><option>–ë–µ–ª–∞—Ä—É—Å–∫–∞—è</option><option>–£–∫—Ä–∞–∏–Ω—Å–∫–∞—è</option><option>English</option><option>Polski</option><option>Fran√ßais</option><option>Deutsch</option></select>
      <div class="sg-title">–®–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤</div>
      <textarea class="ctx-area" style="min-height:80px;">‚Üí –ó–∞–ø–∏—Å—å: dental@labs67.com
‚Üí –ö–∞—Ç–∞–ª–æ–≥: trade@labs67.com
‚Üí –ü–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ: franchise@labs67.com
‚Üí –û–±—É—á–µ–Ω–∏–µ: academi@labs67.com</textarea>
    `;
  } else if (tab === 'settings') {
    body.innerHTML = `
      <div class="sg-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
      <div class="toggle-row"><div><div class="tr-lbl">Email –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ</div><div class="tr-sub">hello@labs67.com</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="toggle-row"><div><div class="tr-lbl">Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div></div><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
      <div class="sg-title">AI –∞–≥–µ–Ω—Ç</div>
      <div class="toggle-row"><div><div class="tr-lbl">–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –≤–∫–ª—é—á—ë–Ω</div><div class="tr-sub">AI –æ—Ç–≤–µ—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="toggle-row"><div><div class="tr-lbl">–°–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∏–∞–ª–æ–≥–∏</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="sg-title">–ú–æ–¥–µ–ª—å AI</div>
      <select class="sel-fi"><option>Claude Sonnet 4.5</option><option>Claude Haiku (–±—ã—Å—Ç—Ä—ã–π)</option><option>GPT-4o</option><option>Gemini Flash (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)</option></select>
      <div class="sg-title">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div>
      <div class="int-row"><div><div class="int-lbl">Supabase DB</div><div class="int-sub ok">‚óè –ü–æ–¥–∫–ª—é—á–µ–Ω–æ</div></div><div class="int-btn ok-btn">‚úì OK</div></div>
      <div class="int-row"><div><div class="int-lbl">OpenRouter API</div><div class="int-sub err">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div></div><button class="int-btn" onclick="notify('–î–æ–±–∞–≤—å—Ç–µ API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö')">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button></div>
      <div class="int-row"><div><div class="int-lbl">Telegram Bot</div><div class="int-sub err">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div></div><button class="int-btn" onclick="notify('–ù—É–∂–µ–Ω BOT_TOKEN –æ—Ç @BotFather')">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button></div>
    `;
  }
}

// ‚îÄ‚îÄ RENDER DETAIL ‚îÄ‚îÄ
function renderDetail() {
  const l = currentLead;
  if (!l) return;
  const body = document.getElementById('rpBody');
  const time = new Date(l.created_at).toLocaleString('ru-RU');
  body.innerHTML = `
    <div class="ld-section">
      <div class="ld-lbl">–ö–æ–Ω—Ç–∞–∫—Ç</div>
      <div class="ld-val">${l.name || '–ê–Ω–æ–Ω–∏–º'}</div>
      <div class="ld-sm">${l.phone || '‚Äî'}</div>
      <div class="ld-sm">${l.email || '‚Äî'}</div>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–ò—Å—Ç–æ—á–Ω–∏–∫</div>
      <div class="ld-val" style="color:var(--gold)">${(l.source||'main').toUpperCase()}.labs67.com</div>
      <div class="ld-sm">${time}</div>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–ó–∞–ø—Ä–æ—Å</div>
      <div class="ld-sm" style="line-height:1.6;">${l.message || '‚Äî'}</div>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–°—Ç–∞—Ç—É—Å</div>
      <div class="status-btns">
        <button class="sb ${l.status==='new'?'s-new':''}" onclick="setStatus('new')">–ù–æ–≤—ã–π</button>
        <button class="sb ${l.status==='hot'?'s-hot':''}" onclick="setStatus('hot')">üî• –ì–æ—Ä—è—á–∏–π</button>
        <button class="sb ${l.status==='contacted'?'s-done':''}" onclick="setStatus('contacted')">Contacted</button>
        <button class="sb ${l.status==='done'?'s-done':''}" onclick="setStatus('done')">‚úì –ó–∞–∫—Ä—ã—Ç</button>
      </div>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–ó–∞–º–µ—Ç–∫–∞</div>
      <textarea class="note-area" id="noteArea" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É...">${l.note||''}</textarea>
      <button class="save-btn" onclick="saveNote()">// –°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
    <hr class="ld-div">
    <div class="ld-section">
      <div class="ld-lbl">–î–µ–π—Å—Ç–≤–∏—è</div>
      <button class="action-btn" onclick="notify('üìß Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ${l.email||''}')" >‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞ ${l.email||'email'}</button>
      <button class="action-btn" onclick="notify('üìû –ó–≤–æ–Ω–æ–∫: ${l.phone||''}')" >üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å ${l.phone||''}</button>
    </div>
  `;
}

async function saveNote() {
  const note = document.getElementById('noteArea')?.value;
  if (!currentLead) return;
  await sb.from('leads').update({note}).eq('id', currentLead.id);
  currentLead.note = note;
  notify('–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úì');
}

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.fb').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderLeads();
}

// ‚îÄ‚îÄ REALTIME ‚îÄ‚îÄ
function subscribeRealtime() {
  sb.channel('leads-channel')
    .on('postgres_changes', {event:'INSERT', schema:'public', table:'leads'}, payload => {
      leads.unshift(payload.new);
      renderLeads();
      notify(`üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞: ${payload.new.name || '–ê–Ω–æ–Ω–∏–º'} ¬∑ ${(payload.new.source||'main').toUpperCase()}`);
    })
    .on('postgres_changes', {event:'UPDATE', schema:'public', table:'leads'}, payload => {
      leads = leads.map(l => l.id === payload.new.id ? payload.new : l);
      if (currentLead?.id === payload.new.id) currentLead = payload.new;
      renderLeads();
    })
    .subscribe();

  sb.channel('msgs-channel')
    .on('postgres_changes', {event:'INSERT', schema:'public', table:'chat_messages'}, payload => {
      if (currentLead && payload.new.lead_id === currentLead.id) {
        messages.push(payload.new);
        renderMsgs();
      }
    })
    .subscribe();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OFFICE ‚Äî TOP-DOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TD_STATE_ICO = { working:'üíª', coffee:'‚òï', talking:'üí¨', idle:'üí§' };
const TD_STATES = ['working','coffee','talking','idle'];

// –ü–æ–∑–∏—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤ –≤ –æ—Ñ–∏—Å–µ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é
const TD_POSITIONS = {
  kai: {
    working: {left:'88px', top:'130px'},
    coffee:  {left:'calc(60% - 80px)', top:'200px'},
    talking: {left:'155px', top:'115px'},
    idle:    {left:'70px', top:'290px'}
  },
  stepa: {
    working: {left:'228px', top:'130px'},
    coffee:  {left:'calc(60% - 40px)', top:'200px'},
    talking: {left:'195px', top:'115px'},
    idle:    {left:'210px', top:'290px'}
  }
};

let tdRotateTimer = null;
let tdSelected = 'kai';

function initOffice() {
  // –ê–≤—Ç–æ-—Ä–æ—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
  if (tdRotateTimer) clearInterval(tdRotateTimer);
  tdRotateTimer = setInterval(() => {
    const ks = TD_STATES[Math.floor(Math.random() * TD_STATES.length)];
    const ss = TD_STATES[Math.floor(Math.random() * TD_STATES.length)];
    tdSetState('kai', ks, null);
    tdSetState('stepa', ss, null);
  }, 30000);
}

function tdSetState(agent, state, btn) {
  const el = document.getElementById('td-' + agent);
  if (!el) return;
  el.setAttribute('data-state', state);
  // –ò–∫–æ–Ω–∫–∞
  const ico = document.getElementById('td-' + agent + '-ico');
  if (ico) ico.textContent = TD_STATE_ICO[state] || '‚ö°';
  // –ü–æ–∑–∏—Ü–∏—è
  const pos = TD_POSITIONS[agent] && TD_POSITIONS[agent][state];
  if (pos) { el.style.left = pos.left; el.style.top = pos.top; }
  // –ö–Ω–æ–ø–∫–∏
  const grpLbl = agent === 'kai' ? '–ö–ê–ô' : '–°–¢–ï–ü–ê';
  document.querySelectorAll('.td-ctrl-grp').forEach(g => {
    const lbl = g.querySelector('.td-ctrl-lbl');
    if (!lbl || !lbl.textContent.includes(grpLbl)) return;
    g.querySelectorAll('.td-cbtn').forEach(b => b.classList.remove('on'));
    if (btn) btn.classList.add('on');
  });
}

function tdSelectAgent(agent) {
  tdSelected = agent;
  document.querySelectorAll('.td-agent').forEach(el => el.classList.remove('active'));
  const el = document.getElementById('td-' + agent);
  if (el) el.classList.add('active');
}

// –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º
function setAgentState(agent, state, btn) { tdSetState(agent, state, btn); }
function syncControlButtons(agent, state) {}
function initOffice_legacy() {}
}

// ‚îÄ‚îÄ NOTIFY ‚îÄ‚îÄ
function notify(msg, isErr=false) {
  const el = document.createElement('div');
  el.className = 'notif' + (isErr?' err':'');
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 3500);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadLeads();
subscribeRealtime();
</script>

  <!-- CURRENCY CONVERTER -->
  <div style="position:fixed;bottom:18px;left:18px;z-index:200;background:var(--panel);border:1px solid var(--b1);padding:12px 14px;width:210px;">
    <div style="font-family:'JetBrains Mono',monospace;font-size:0.45rem;letter-spacing:0.2em;color:var(--gold);margin-bottom:8px;">// –ö–£–†–° NBP</div>
    <div style="display:flex;gap:6px;margin-bottom:8px;">
      <input id="cvAmt" type="number" value="1000" style="flex:1;padding:5px 8px;background:rgba(0,0,0,0.4);border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.62rem;outline:none;">
      <select id="cvFrom" style="padding:5px;background:#08101f;border:1px solid var(--b1);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.55rem;outline:none;">
        <option>PLN</option><option>EUR</option><option>USD</option>
      </select>
    </div>
    <div id="cvResult" style="font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--green);margin-bottom:6px;">‚Üí –†–∞—Å—á—ë—Ç...</div>
    <div id="cvRate" style="font-family:'JetBrains Mono',monospace;font-size:0.42rem;color:var(--muted);">–ö—É—Ä—Å NBP –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
  </div>
  <script>
  (async()=>{
    let rates={EUR:4.2233,USD:3.5804};
    try{
      const r=await fetch('https://api.nbp.pl/api/exchangerates/tables/a/?format=json');
      const d=await r.json();
      d[0].rates.forEach(x=>{rates[x.code]=x.mid;});
      document.getElementById('cvRate').textContent=`NBP: 1 EUR = ${rates.EUR.toFixed(4)} PLN`;
    }catch(e){}
    function convert(){
      const amt=parseFloat(document.getElementById('cvAmt').value)||0;
      const from=document.getElementById('cvFrom').value;
      let pln=from==='PLN'?amt:amt*rates[from];
      const eur=Math.ceil(pln/rates.EUR);
      const usd=Math.ceil(pln/rates.USD);
      document.getElementById('cvResult').innerHTML=
        from==='PLN'
          ? `‚Üí ${Math.ceil(pln/rates.EUR)} EUR ¬∑ ${Math.ceil(pln/rates.USD)} USD`
          : `‚Üí ${Math.ceil(pln)} PLN ¬∑ ${Math.ceil(pln/rates.EUR)} EUR`;
    }
    document.getElementById('cvAmt').oninput=convert;
    document.getElementById('cvFrom').onchange=convert;
    convert();
  })();
  </script>
</body>
</html>
